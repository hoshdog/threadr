<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Threadr - Convert Articles to X Threads</title>
    <script src="config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'x-black': '#000000',
                        'x-dark': '#15202b',
                        'x-darker': '#192734', 
                        'x-darkest': '#22303c',
                        'x-gray': '#8899ac',
                        'x-light-gray': '#e1e8ed',
                        'x-blue': '#1d9bf0',
                        'x-blue-hover': '#1a8cd8',
                        'x-border': '#38444d',
                        'x-hover': '#1d2d3a'
                    },
                    fontFamily: {
                        'inter': ['Inter', 'system-ui', '-apple-system', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        * {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        body {
            background-color: #000000;
            color: #ffffff;
        }
        .tweet-editor:focus { 
            outline: none; 
            background-color: #0a0a0a;
        }
        .loading-spinner {
            border: 2px solid #38444d;
            border-top: 2px solid #1d9bf0;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .sidebar-transition {
            transition: all 0.2s ease-in-out;
        }
        .nav-item {
            transition: all 0.2s ease-in-out;
        }
        .nav-item:hover {
            background-color: #1d2d3a;
        }
        .glass-effect {
            backdrop-filter: blur(12px);
            background-color: rgba(0, 0, 0, 0.8);
        }
        .tweet-card {
            background-color: #000000;
            border: 1px solid #2f3336;
            transition: all 0.2s ease-in-out;
        }
        .tweet-card:hover {
            border-color: #536471;
        }
        .button-primary {
            background-color: #1d9bf0;
            transition: all 0.2s ease-in-out;
        }
        .button-primary:hover {
            background-color: #1a8cd8;
        }
        .button-secondary {
            background-color: #0f1419;
            border: 1px solid #536471;
            transition: all 0.2s ease-in-out;
        }
        .button-secondary:hover {
            background-color: #1d2d3a;
        }
        .form-input {
            background-color: #000000;
            border: 1px solid #333639;
            color: #ffffff;
            transition: all 0.2s ease-in-out;
        }
        .form-input:focus {
            border-color: #1d9bf0;
            box-shadow: 0 0 0 1px #1d9bf0;
        }
        .form-input::placeholder {
            color: #71767b;
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-x-black text-white min-h-screen font-inter">
    <!-- Mobile Header -->
    <div class="lg:hidden flex items-center justify-between p-4 border-b border-x-border">
        <div class="flex items-center space-x-3">
            <svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
            <h1 class="text-xl font-bold">Threadr</h1>
        </div>
        <button @click="sidebarOpen = !sidebarOpen" class="p-2 rounded-full hover:bg-x-hover">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
        </button>
    </div>

    <div x-data="threadrApp()" class="flex min-h-screen">
        <!-- Sidebar -->
        <div class="sidebar-transition fixed lg:relative inset-y-0 left-0 z-50 w-64 lg:w-72 transform lg:transform-none" 
             :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'">
            <div class="glass-effect lg:bg-x-black h-full border-r border-x-border flex flex-col">
                <!-- Logo -->
                <div class="p-6 border-b border-x-border">
                    <div class="flex items-center space-x-3">
                        <svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                        <h1 class="text-2xl font-bold text-white">Threadr</h1>
                    </div>
                    <p class="text-x-gray text-sm mt-2">Convert articles to X threads</p>
                </div>

                <!-- Navigation -->
                <nav class="flex-1 p-4 space-y-2">
                    <div 
                        @click="switchToPage('generate')"
                        :class="currentPage === 'generate' ? 'bg-x-blue text-white' : 'text-x-gray hover:text-white'"
                        class="nav-item rounded-xl p-3 cursor-pointer"
                    >
                        <div class="flex items-center space-x-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"/>
                            </svg>
                            <span class="font-medium">Generate Thread</span>
                        </div>
                    </div>
                    
                    <div 
                        @click="switchToPage('history')"
                        :class="currentPage === 'history' ? 'bg-x-blue text-white' : 'text-x-gray hover:text-white'"
                        class="nav-item rounded-xl p-3 cursor-pointer"
                    >
                        <div class="flex items-center space-x-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span class="font-medium">History</span>
                        </div>
                    </div>
                    
                    <div class="nav-item rounded-xl p-3 text-x-gray hover:text-white cursor-pointer">
                        <div class="flex items-center space-x-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            <span class="font-medium">Analytics</span>
                            <span class="text-xs bg-x-gray text-x-black px-2 py-1 rounded-full">Soon</span>
                        </div>
                    </div>
                </nav>

                <!-- User Section -->
                <div class="p-4 border-t border-x-border">
                    <div x-show="!user" class="space-y-2">
                        <button 
                            @click="showAuthModal('signup')"
                            class="w-full button-primary text-white font-semibold py-3 px-4 rounded-full"
                        >
                            Sign Up
                        </button>
                        <button 
                            @click="showAuthModal('login')"
                            class="w-full button-secondary text-white font-medium py-3 px-4 rounded-full"
                        >
                            Login
                        </button>
                    </div>
                    
                    <div x-show="user" class="relative" x-data="{ showDropdown: false }">
                        <button 
                            @click="showDropdown = !showDropdown"
                            class="w-full flex items-center space-x-3 p-3 rounded-xl hover:bg-x-hover transition-colors duration-200"
                        >
                            <div class="w-10 h-10 bg-x-blue rounded-full flex items-center justify-center text-white font-semibold">
                                <span x-text="user?.email?.charAt(0).toUpperCase()"></span>
                            </div>
                            <div class="flex-1 text-left">
                                <div class="text-white font-semibold text-sm" x-text="user?.email"></div>
                                <div class="text-x-gray text-xs">Free Plan</div>
                            </div>
                            <svg class="w-4 h-4 text-x-gray" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        
                        <div 
                            x-show="showDropdown" 
                            @click.away="showDropdown = false"
                            x-transition:enter="transition ease-out duration-100"
                            x-transition:enter-start="transform opacity-0 scale-95"
                            x-transition:enter-end="transform opacity-100 scale-100"
                            x-transition:leave="transition ease-in duration-75"
                            x-transition:leave-start="transform opacity-100 scale-100"
                            x-transition:leave-end="transform opacity-0 scale-95"
                            class="absolute bottom-full left-0 right-0 mb-2 bg-x-dark rounded-xl border border-x-border shadow-2xl py-2 z-50"
                        >
                            <button 
                                @click="logout(); showDropdown = false"
                                class="block w-full text-left px-4 py-3 text-white hover:bg-x-hover transition-colors duration-200"
                            >
                                <div class="flex items-center space-x-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                                    </svg>
                                    <span>Logout</span>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overlay for mobile -->
        <div x-show="sidebarOpen" 
             @click="sidebarOpen = false"
             x-transition:enter="transition-opacity ease-linear duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition-opacity ease-linear duration-300"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden"></div>

        <!-- Main Content -->
        <div class="flex-1 lg:ml-0">
            <div class="max-w-2xl mx-auto p-6 lg:p-8">
                <!-- Generate Thread Page -->
                <div x-show="currentPage === 'generate'" x-transition>
                    <!-- Header -->
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-white mb-2">Create Your Thread</h2>
                        <p class="text-x-gray">Transform any article or content into an engaging X thread</p>
                    </div>

                <!-- Main Form Card -->
                <div class="tweet-card rounded-2xl p-6 mb-6">
                    <!-- Input Type Toggle -->
                    <div class="flex justify-center mb-8">
                        <div class="inline-flex rounded-full bg-x-dark border border-x-border p-2">
                            <button 
                                @click="inputType = 'url'"
                                :class="inputType === 'url' ? 'bg-x-blue text-white' : 'text-x-gray hover:text-white'"
                                class="px-6 py-2 rounded-full font-semibold transition-all duration-200"
                            >
                                URL
                            </button>
                            <button 
                                @click="inputType = 'text'"
                                :class="inputType === 'text' ? 'bg-x-blue text-white' : 'text-x-gray hover:text-white'"
                                class="px-6 py-2 rounded-full font-semibold transition-all duration-200"
                            >
                                Paste Text
                            </button>
                        </div>
                    </div>

                    <!-- URL Input -->
                    <div x-show="inputType === 'url'" x-transition>
                        <label class="block text-sm font-semibold text-white mb-3">Article URL</label>
                        <input 
                            type="url" 
                            x-model="urlInput"
                            id="url-input"
                            placeholder="https://medium.com/article-title"
                            class="form-input w-full px-4 py-4 rounded-xl text-lg"
                            @keyup.enter="generateThread()"
                            @input="urlInput = $event.target.value"
                            @paste="setTimeout(() => { urlInput = $event.target.value }, 10)"
                        >
                        <p class="text-x-gray text-sm mt-2">Supports Medium, Dev.to, Substack, and more</p>
                    </div>

                    <!-- Text Input -->
                    <div x-show="inputType === 'text'" x-transition>
                        <label class="block text-sm font-semibold text-white mb-3">Paste your content</label>
                        <textarea 
                            x-model="textInput"
                            id="text-input"
                            placeholder="Paste your article content here..."
                            rows="8"
                            class="form-input w-full px-4 py-4 rounded-xl text-lg resize-none"
                            @input="textInput = $event.target.value"
                            @paste="setTimeout(() => { textInput = $event.target.value }, 10)"
                        ></textarea>
                        <p class="text-x-gray text-sm mt-2">Paste any text content to convert into a thread</p>
                    </div>

                    <!-- Generate Button -->
                    <button 
                        @click="generateThread()"
                        :disabled="loading || (!urlInput && inputType === 'url') || (!textInput && inputType === 'text')"
                        class="w-full mt-8 button-primary text-white font-bold py-4 px-8 rounded-full text-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span x-show="!loading" class="flex items-center justify-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            <span>Generate Thread</span>
                        </span>
                        <span x-show="loading" class="flex items-center justify-center space-x-3">
                            <div class="loading-spinner"></div>
                            <span>Generating...</span>
                        </span>
                    </button>

                    <!-- Error Message -->
                    <div x-show="error" x-transition class="mt-6 p-4 bg-red-900/20 border border-red-800/30 rounded-xl">
                        <div class="flex items-center space-x-2">
                            <svg class="w-5 h-5 text-red-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p class="text-red-300" x-text="error"></p>
                        </div>
                    </div>
                </div>

                <!-- Generated Thread -->
                <div x-show="tweets.length > 0" x-transition class="tweet-card rounded-2xl p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-xl font-bold text-white">Your Thread</h2>
                            <p class="text-x-gray text-sm">Edit any tweet by clicking on it</p>
                        </div>
                        <button 
                            @click="copyAllTweets()"
                            class="button-secondary text-white font-semibold py-2 px-4 rounded-full flex items-center space-x-2"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                            <span x-show="!copiedAll">Copy All</span>
                            <span x-show="copiedAll">Copied!</span>
                        </button>
                    </div>

                    <!-- Tweet List -->
                    <div class="space-y-4">
                        <template x-for="(tweet, index) in tweets" :key="index">
                            <div class="bg-x-black border border-x-border rounded-xl p-4 hover:border-x-gray/50 transition-all duration-200">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs text-x-gray font-semibold bg-x-dark px-2 py-1 rounded-full" x-text="`${index + 1}/${tweets.length}`"></span>
                                        <div class="w-8 h-8 bg-x-blue rounded-full flex items-center justify-center">
                                            <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <button 
                                        @click="copyTweet(index)"
                                        class="text-xs text-x-blue hover:text-x-blue-hover font-semibold px-3 py-1 rounded-full border border-x-blue/20 hover:border-x-blue/40 transition-all duration-200"
                                    >
                                        <span x-show="!tweet.copied" class="flex items-center space-x-1">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                            </svg>
                                            <span>Copy</span>
                                        </span>
                                        <span x-show="tweet.copied" class="flex items-center space-x-1">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                            </svg>
                                            <span>Copied!</span>
                                        </span>
                                    </button>
                                </div>
                                <div 
                                    contenteditable="true"
                                    @input="updateTweet(index, $event)"
                                    @blur="validateTweetLength(index)"
                                    class="tweet-editor text-white leading-relaxed min-h-[80px] p-3 rounded-lg focus:bg-x-dark/50 transition-colors duration-200"
                                    x-text="tweet.text"
                                ></div>
                                <div class="mt-3 flex justify-between items-center">
                                    <div class="flex items-center space-x-4 text-x-gray">
                                        <div class="flex items-center space-x-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                            </svg>
                                            <span class="text-sm">0</span>
                                        </div>
                                        <div class="flex items-center space-x-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                            </svg>
                                            <span class="text-sm">0</span>
                                        </div>
                                        <div class="flex items-center space-x-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                            </svg>
                                            <span class="text-sm">0</span>
                                        </div>
                                    </div>
                                    <div class="text-sm" :class="tweet.text.length > 280 ? 'text-red-400' : 'text-x-gray'">
                                        <span x-text="tweet.text.length"></span><span class="text-x-gray">/280</span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                </div>

                <!-- History Page -->
                <div x-show="currentPage === 'history'" x-transition>
                    <!-- Header -->
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-white mb-2">Thread History</h2>
                        <p class="text-x-gray">View and manage your saved threads</p>
                    </div>

                    <!-- Search Bar -->
                    <div class="tweet-card rounded-2xl p-6 mb-6">
                        <div class="relative">
                            <input 
                                type="text" 
                                x-model="searchQuery"
                                @input="debounceSearch()"
                                placeholder="Search your threads..."
                                class="form-input w-full px-4 py-4 pl-12 rounded-xl text-lg"
                            >
                            <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-x-gray" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div x-show="historyLoading" class="tweet-card rounded-2xl p-12 text-center">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-x-gray">Loading your threads...</p>
                    </div>

                    <!-- Error State -->
                    <div x-show="historyError && !historyLoading" class="tweet-card rounded-2xl p-6 mb-6">
                        <div class="flex items-center space-x-2 text-red-400">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p x-text="historyError"></p>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div x-show="!historyLoading && !historyError && threadHistory.length === 0" class="tweet-card rounded-2xl p-12 text-center">
                        <div class="w-16 h-16 bg-x-dark rounded-full flex items-center justify-center mx-auto mb-6">
                            <svg class="w-8 h-8 text-x-gray" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-2">No threads yet</h3>
                        <p class="text-x-gray mb-6">Create your first thread to see it here</p>
                        <button 
                            @click="switchToPage('generate')"
                            class="button-primary text-white font-semibold py-3 px-6 rounded-full"
                        >
                            Create Thread
                        </button>
                    </div>

                    <!-- Thread List -->
                    <div x-show="!historyLoading && !historyError && threadHistory.length > 0" class="space-y-4">
                        <template x-for="thread in filteredThreads()" :key="thread.id">
                            <div class="tweet-card rounded-2xl p-6 hover:border-x-gray/50 transition-all duration-200">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex-1">
                                        <h3 class="text-lg font-semibold text-white mb-2 cursor-pointer hover:text-x-blue transition-colors" 
                                            @click="viewThread(thread)" 
                                            x-text="thread.title || 'Untitled Thread'">
                                        </h3>
                                        <div class="flex items-center space-x-4 text-sm text-x-gray">
                                            <span x-text="formatDate(thread.created_at)"></span>
                                            <span x-text="`${thread.tweet_count} tweets`"></span>
                                            <span x-show="thread.source_url" class="truncate max-w-xs">
                                                <span x-text="thread.source_url"></span>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2 ml-4">
                                        <!-- Favorite Button -->
                                        <button 
                                            @click="toggleFavorite(thread)"
                                            :class="thread.is_favorite ? 'text-yellow-400' : 'text-x-gray hover:text-yellow-400'"
                                            class="p-2 rounded-full hover:bg-x-hover transition-colors"
                                        >
                                            <svg class="w-5 h-5" :fill="thread.is_favorite ? 'currentColor' : 'none'" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                                            </svg>
                                        </button>
                                        <!-- Copy Thread Button -->
                                        <button 
                                            @click="copyThread(thread)"
                                            class="p-2 rounded-full text-x-gray hover:text-x-blue hover:bg-x-hover transition-colors"
                                        >
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                            </svg>
                                        </button>
                                        <!-- Delete Button -->
                                        <button 
                                            @click="deleteThread(thread)"
                                            class="p-2 rounded-full text-x-gray hover:text-red-400 hover:bg-x-hover transition-colors"
                                        >
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Thread Preview -->
                                <div class="text-x-gray text-sm line-clamp-2" x-text="thread.preview"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Thread Detail Modal -->
        <div 
            x-show="showThreadModal" 
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"
            @click.self="closeThreadModal()"
        >
            <div 
                x-show="showThreadModal"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 transform scale-95"
                x-transition:enter-end="opacity-100 transform scale-100"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 transform scale-100"
                x-transition:leave-end="opacity-0 transform scale-95"
                class="bg-x-black border border-x-border rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden"
            >
                <!-- Modal Header -->
                <div class="flex justify-between items-center p-6 border-b border-x-border">
                    <div>
                        <h3 class="text-xl font-bold text-white" x-text="selectedThread?.title || 'Thread Details'"></h3>
                        <div class="flex items-center space-x-4 text-sm text-x-gray mt-1">
                            <span x-text="formatDate(selectedThread?.created_at)"></span>
                            <span x-text="`${selectedThread?.tweet_count} tweets`"></span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <!-- Copy Thread Button -->
                        <button 
                            @click="copyThread(selectedThread)"
                            class="p-2 rounded-full text-x-gray hover:text-x-blue hover:bg-x-hover transition-colors"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                        </button>
                        <!-- Close Button -->
                        <button 
                            @click="closeThreadModal()"
                            class="p-2 rounded-full text-x-gray hover:text-white hover:bg-x-hover transition-colors"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Modal Content -->
                <div class="p-6 overflow-y-auto max-h-[calc(90vh-8rem)]">
                    <template x-if="selectedThread && selectedThread.tweets">
                        <div class="space-y-4">
                            <template x-for="(tweet, index) in selectedThread.tweets" :key="index">
                                <div class="bg-x-dark rounded-xl p-4">
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex items-center space-x-2">
                                            <span class="text-xs text-x-gray font-semibold bg-x-black px-2 py-1 rounded-full" x-text="`${index + 1}/${selectedThread.tweets.length}`"></span>
                                            <div class="w-8 h-8 bg-x-blue rounded-full flex items-center justify-center">
                                                <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                                                </svg>
                                            </div>
                                        </div>
                                        <button 
                                            @click="copyTweetFromModal(tweet, index)"
                                            class="text-xs text-x-blue hover:text-x-blue-hover font-semibold px-3 py-1 rounded-full border border-x-blue/20 hover:border-x-blue/40 transition-all duration-200"
                                        >
                                            <span x-show="!tweet.copied" class="flex items-center space-x-1">
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                                </svg>
                                                <span>Copy</span>
                                            </span>
                                            <span x-show="tweet.copied" class="flex items-center space-x-1">
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                </svg>
                                                <span>Copied!</span>
                                            </span>
                                        </button>
                                    </div>
                                    <div class="text-white leading-relaxed" x-text="tweet.content || tweet.text"></div>
                                    <div class="mt-3 text-sm text-x-gray">
                                        <span x-text="(tweet.content || tweet.text).length"></span><span>/280</span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Authentication Modal -->
        <div 
            x-show="authModalVisible" 
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"
            @click.self="closeAuthModal()"
        >
            <div 
                x-show="authModalVisible"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 transform scale-95"
                x-transition:enter-end="opacity-100 transform scale-100"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 transform scale-100"
                x-transition:leave-end="opacity-0 transform scale-95"
                class="bg-x-black border border-x-border rounded-2xl shadow-2xl p-8 max-w-md w-full"
            >
                <!-- Modal Header -->
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h3 class="text-2xl font-bold text-white" x-text="authMode === 'login' ? 'Welcome back' : 'Join Threadr'"></h3>
                        <p class="text-x-gray text-sm mt-1" x-text="authMode === 'login' ? 'Sign in to your account' : 'Create your account'"></p>
                    </div>
                    <button 
                        @click="closeAuthModal()"
                        class="text-x-gray hover:text-white transition-colors duration-200 p-2 rounded-full hover:bg-x-hover"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Auth Form -->
                <form @submit.prevent="handleAuth()" class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold text-white mb-3">Email</label>
                        <input 
                            type="email" 
                            x-model="authForm.email"
                            placeholder="your@email.com"
                            required
                            class="form-input w-full px-4 py-4 rounded-xl"
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-white mb-3">Password</label>
                        <input 
                            type="password" 
                            x-model="authForm.password"
                            placeholder="Password"
                            required
                            class="form-input w-full px-4 py-4 rounded-xl"
                        >
                    </div>
                    
                    <!-- Remember Me Checkbox (only for login) -->
                    <div x-show="authMode === 'login'" x-transition class="flex items-center">
                        <input 
                            type="checkbox" 
                            x-model="authForm.rememberMe"
                            id="remember-me"
                            class="w-4 h-4 text-x-blue bg-x-black border-x-border rounded focus:ring-x-blue focus:ring-2"
                        >
                        <label for="remember-me" class="ml-2 text-sm text-x-gray">
                            Keep me signed in for 30 days
                        </label>
                    </div>
                    
                    <!-- Confirm Password (only for signup) -->
                    <div x-show="authMode === 'signup'" x-transition>
                        <label class="block text-sm font-semibold text-white mb-3">Confirm Password</label>
                        <input 
                            type="password" 
                            x-model="authForm.confirmPassword"
                            placeholder="Confirm Password"
                            x-bind:required="authMode === 'signup'"
                            class="form-input w-full px-4 py-4 rounded-xl"
                        >
                    </div>
                    
                    <!-- Error Message -->
                    <div x-show="authError" x-transition class="p-4 bg-red-900/20 border border-red-800/30 rounded-xl">
                        <div class="flex items-center space-x-2">
                            <svg class="w-4 h-4 text-red-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p class="text-red-300 text-sm" x-text="authError"></p>
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <button 
                        type="submit"
                        :disabled="authLoading"
                        class="w-full button-primary text-white font-bold py-4 px-6 rounded-full disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span x-show="!authLoading" x-text="authMode === 'login' ? 'Sign In' : 'Create Account'"></span>
                        <span x-show="authLoading" class="flex items-center justify-center space-x-2">
                            <div class="loading-spinner"></div>
                            <span x-text="authMode === 'login' ? 'Signing in...' : 'Creating account...'"></span>
                        </span>
                    </button>
                </form>
                
                <!-- Toggle Auth Mode -->
                <div class="mt-8 text-center">
                    <p class="text-x-gray">
                        <span x-text="authMode === 'login' ? 'Don\'t have an account?' : 'Already have an account?'"></span>
                        <button 
                            @click="toggleAuthMode()"
                            class="text-x-blue hover:text-x-blue-hover font-semibold ml-2 transition-colors duration-200"
                            x-text="authMode === 'login' ? 'Sign up' : 'Sign in'"
                        ></button>
                    </p>
                </div>
            </div>
        </div>

        <!-- Payment Required Modal -->
        <div 
            x-show="showPaymentModal" 
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"
            @click.self="closePaymentModal()"
        >
            <div 
                x-show="showPaymentModal"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 transform scale-95"
                x-transition:enter-end="opacity-100 transform scale-100"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 transform scale-100"
                x-transition:leave-end="opacity-0 transform scale-95"
                class="bg-x-black border border-x-border rounded-2xl shadow-2xl p-8 max-w-md w-full"
            >
                <div class="text-center">
                    <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 mb-6">
                        <svg class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                        </svg>
                    </div>
                    
                    <h3 class="text-2xl font-bold text-white mb-2">Upgrade to Premium</h3>
                    
                    <p class="text-x-gray mb-6">
                        You've reached your daily limit of <span class="text-white font-semibold" x-text="paymentData?.limit || 5"></span> free threads.
                    </p>
                    
                    <div x-show="paymentData?.usage" class="bg-x-dark rounded-xl p-4 mb-6 text-sm">
                        <p class="text-x-gray">
                            Today's usage: <span class="text-white font-semibold" x-text="paymentData?.usage?.threads_today || 0"></span> / <span x-text="paymentData?.limit || 5"></span> threads
                        </p>
                        <p class="text-x-gray mt-1" x-show="paymentData?.usage?.total_threads">
                            Total threads created: <span class="text-white font-semibold" x-text="paymentData?.usage?.total_threads"></span>
                        </p>
                    </div>
                    
                    <div class="mb-8">
                        <h4 class="font-semibold text-white mb-4">Premium Benefits:</h4>
                        <ul class="text-sm text-x-gray text-left space-y-3">
                            <li class="flex items-center space-x-3">
                                <div class="w-5 h-5 bg-green-500 rounded-full flex items-center justify-center">
                                    <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </div>
                                <span>Unlimited threads per day</span>
                            </li>
                            <li class="flex items-center space-x-3">
                                <div class="w-5 h-5 bg-green-500 rounded-full flex items-center justify-center">
                                    <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </div>
                                <span>Priority processing</span>
                            </li>
                            <li class="flex items-center space-x-3">
                                <div class="w-5 h-5 bg-green-500 rounded-full flex items-center justify-center">
                                    <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </div>
                                <span>Advanced editing features</span>
                            </li>
                            <li class="flex items-center space-x-3">
                                <div class="w-5 h-5 bg-green-500 rounded-full flex items-center justify-center">
                                    <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </div>
                                <span>Export to multiple formats</span>
                            </li>
                        </ul>
                    </div>
                    
                    <div x-show="paymentData?.price" class="mb-8">
                        <div class="bg-gradient-to-r from-x-blue to-purple-600 rounded-xl p-4">
                            <p class="text-3xl font-bold text-white">
                                $<span x-text="paymentData?.price"></span><span class="text-lg font-normal text-white/80">/month</span>
                            </p>
                            <p class="text-white/80 text-sm mt-1">Cancel anytime</p>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button 
                            @click="closePaymentModal()"
                            class="flex-1 px-6 py-3 button-secondary text-white font-semibold rounded-full transition-colors duration-200"
                        >
                            Maybe Later
                        </button>
                        <button 
                            @click="upgradeNow()"
                            :disabled="!paymentConfig?.payment_url"
                            :class="paymentConfig?.payment_url ? 'button-primary' : 'bg-x-gray cursor-not-allowed'"
                            class="flex-1 px-6 py-3 text-white font-bold rounded-full transition-colors duration-200 text-center"
                        >
                            <span x-show="paymentConfig?.payment_url">Upgrade Now</span>
                            <span x-show="!paymentConfig?.payment_url">Coming Soon</span>
                        </button>
                    </div>
                    
                    <p class="text-xs text-x-gray mt-4">
                        Try again tomorrow for more free threads!
                    </p>
                </div>
            </div>
        </div>

    </div>

    <script>
        function threadrApp() {
            return {
                inputType: 'url',
                urlInput: '',
                textInput: '',
                tweets: [],
                loading: false,
                error: '',
                copiedAll: false,
                showPaymentModal: false,
                paymentData: null,
                paymentConfig: null,
                
                // Authentication state
                user: null,
                authModalVisible: false,
                authMode: 'login', // 'login' or 'signup'
                authForm: {
                    email: '',
                    password: '',
                    confirmPassword: '',
                    rememberMe: false
                },
                authLoading: false,
                authError: '',
                
                sidebarOpen: false,
                
                // Page state
                currentPage: 'generate', // 'generate' or 'history'
                
                // History state
                threadHistory: [],
                historyLoading: false,
                historyError: '',
                searchQuery: '',
                searchTimeout: null,
                selectedThread: null,
                showThreadModal: false,
                
                // Initialize authentication on component load
                init() {
                    this.loadUserFromStorage();
                },
                
                // Check if user is authenticated
                isAuthenticated() {
                    return !!this.user && !!this.getAuthToken();
                },
                
                // Get stored JWT token
                getAuthToken() {
                    return localStorage.getItem('threadr_token');
                },
                
                // Get stored refresh token
                getRefreshToken() {
                    return localStorage.getItem('threadr_refresh_token');
                },
                
                // Load user data from localStorage
                loadUserFromStorage() {
                    const token = this.getAuthToken();
                    const userData = localStorage.getItem('threadr_user');
                    
                    if (token && userData) {
                        try {
                            this.user = JSON.parse(userData);
                            // Verify token is still valid by checking with backend
                            this.verifyToken();
                        } catch (error) {
                            console.error('Failed to parse user data:', error);
                            this.clearAuthData();
                        }
                    }
                },
                
                // Verify JWT token with backend
                async verifyToken() {
                    const token = this.getAuthToken();
                    if (!token) return;
                    
                    try {
                        const response = await fetch(`${config.API_URL}/api/auth/me`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Accept': 'application/json'
                            }
                        });
                        
                        if (!response.ok) {
                            // Token is invalid, clear auth data
                            this.clearAuthData();
                        } else {
                            const userData = await response.json();
                            this.user = userData;
                            localStorage.setItem('threadr_user', JSON.stringify(userData));
                        }
                    } catch (error) {
                        console.error('Token verification failed:', error);
                        // If token verification fails, try to refresh token
                        if (this.getRefreshToken()) {
                            try {
                                console.log('Attempting token refresh...');
                                await this.refreshAccessToken();
                                console.log('Token refreshed successfully');
                            } catch (refreshError) {
                                console.error('Token refresh failed, clearing auth data:', refreshError);
                                this.clearAuthData();
                            }
                        } else {
                            // No refresh token available, clear auth data
                            this.clearAuthData();
                        }
                    }
                },
                
                // Clear authentication data
                clearAuthData() {
                    this.user = null;
                    localStorage.removeItem('threadr_token');
                    localStorage.removeItem('threadr_refresh_token');
                    localStorage.removeItem('threadr_user');
                },
                
                // Show authentication modal
                showAuthModal(mode = 'login') {
                    this.authMode = mode;
                    this.authForm.email = '';
                    this.authForm.password = '';
                    this.authForm.confirmPassword = '';
                    this.authForm.rememberMe = false;
                    this.authError = '';
                    this.authModalVisible = true;
                },
                
                // Close authentication modal
                closeAuthModal() {
                    this.authModalVisible = false;
                    this.authError = '';
                    this.authLoading = false;
                },
                
                // Toggle between login and signup
                toggleAuthMode() {
                    this.authMode = this.authMode === 'login' ? 'signup' : 'login';
                    this.authError = '';
                },
                
                // Handle authentication (login/signup)
                async handleAuth() {
                    if (!this.authForm.email || !this.authForm.password) {
                        this.authError = 'Please fill in all fields';
                        return;
                    }
                    
                    // Additional validation for signup
                    if (this.authMode === 'signup') {
                        if (!this.authForm.confirmPassword) {
                            this.authError = 'Please confirm your password';
                            return;
                        }
                        if (this.authForm.password !== this.authForm.confirmPassword) {
                            this.authError = 'Passwords do not match';
                            return;
                        }
                    }
                    
                    this.authLoading = true;
                    this.authError = '';
                    
                    try {
                        const endpoint = this.authMode === 'login' ? '/api/auth/login' : '/api/auth/register';
                        const response = await fetch(`${config.API_URL}${endpoint}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify(
                                this.authMode === 'signup' 
                                    ? {
                                        email: this.authForm.email,
                                        password: this.authForm.password,
                                        confirm_password: this.authForm.confirmPassword
                                    }
                                    : {
                                        email: this.authForm.email,
                                        password: this.authForm.password,
                                        remember_me: this.authForm.rememberMe
                                    }
                            )
                        });
                        
                        const data = await response.json();
                        
                        if (!response.ok) {
                            // Handle different error response formats
                            let errorMessage = 'Authentication failed';
                            
                            if (response.status === 422 && data.detail) {
                                // Handle both old and new validation error formats
                                if (Array.isArray(data.detail)) {
                                    // Old FastAPI validation errors format
                                    const validationErrors = data.detail.map(error => {
                                        const field = error.loc ? error.loc[error.loc.length - 1] : 'field';
                                        return `${field}: ${error.msg}`;
                                    }).join(', ');
                                    errorMessage = validationErrors;
                                } else if (typeof data.detail === 'string') {
                                    // New simplified format from our custom handler
                                    errorMessage = data.detail;
                                }
                            } else if (data.detail && typeof data.detail === 'string') {
                                errorMessage = data.detail;
                            } else if (data.message && typeof data.message === 'string') {
                                errorMessage = data.message;
                            } else if (typeof data === 'string') {
                                errorMessage = data;
                            }
                            
                            throw new Error(errorMessage);
                        }
                        
                        // Store token and user data
                        localStorage.setItem('threadr_token', data.access_token);
                        if (data.refresh_token) {
                            localStorage.setItem('threadr_refresh_token', data.refresh_token);
                        }
                        localStorage.setItem('threadr_user', JSON.stringify(data.user));
                        this.user = data.user;
                        
                        // Close modal
                        this.closeAuthModal();
                        
                    } catch (error) {
                        console.error('Authentication error:', error);
                        this.authError = error.message || 'Authentication failed. Please try again.';
                    } finally {
                        this.authLoading = false;
                    }
                },
                
                // Logout user
                async logout() {
                    const token = this.getAuthToken();
                    
                    // Call backend logout endpoint
                    if (token) {
                        try {
                            await fetch(`${config.API_URL}/api/auth/logout`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Accept': 'application/json'
                                }
                            });
                        } catch (error) {
                            console.error('Logout error:', error);
                            // Continue with local logout even if backend call fails
                        }
                    }
                    
                    // Clear local auth data
                    this.clearAuthData();
                },
                
                // Refresh access token using refresh token
                async refreshAccessToken() {
                    const refreshToken = this.getRefreshToken();
                    if (!refreshToken) {
                        throw new Error('No refresh token available');
                    }
                    
                    try {
                        const response = await fetch(`${config.API_URL}/api/auth/refresh`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify({
                                refresh_token: refreshToken
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error('Token refresh failed');
                        }
                        
                        const data = await response.json();
                        
                        // Update stored tokens and user data
                        localStorage.setItem('threadr_token', data.access_token);
                        if (data.refresh_token) {
                            localStorage.setItem('threadr_refresh_token', data.refresh_token);
                        }
                        localStorage.setItem('threadr_user', JSON.stringify(data.user));
                        this.user = data.user;
                        
                        return data.access_token;
                        
                    } catch (error) {
                        console.error('Token refresh failed:', error);
                        // Clear auth data if refresh fails
                        this.clearAuthData();
                        throw error;
                    }
                },

                getHeaders() {
                    const headers = {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    };
                    
                    // Add JWT Bearer token if user is authenticated
                    const token = this.getAuthToken();
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    
                    // Add API key header for non-development environments (ALWAYS needed for /api/generate)
                    const hostname = window.location.hostname;
                    const isDevelopment = hostname === 'localhost' || hostname === '127.0.0.1' || hostname.startsWith('192.168.');
                    
                    if (!isDevelopment) {
                        headers['X-API-Key'] = config.API_KEY || 'zfQBge1AsBBLF8nMNxiHdyFn-_fS7vsTtcTrveXnyD8';
                    }
                    
                    return headers;
                },

                async generateThread() {
                    console.log('Generate thread called');
                    
                    // Basic input validation
                    if (this.inputType === 'url' && !this.urlInput) {
                        this.error = 'Please enter a URL';
                        return;
                    }
                    
                    if (this.inputType === 'text' && !this.textInput) {
                        this.error = 'Please enter some text';
                        return;
                    }

                    this.loading = true;
                    this.error = '';
                    this.tweets = [];

                    try {
                        const headers = this.getHeaders();

                        const response = await fetch(`${config.API_URL}/api/generate`, {
                            method: 'POST',
                            headers: headers,
                            mode: 'cors',
                            credentials: 'omit',
                            body: JSON.stringify(
                                this.inputType === 'url' 
                                    ? { url: this.urlInput }
                                    : { text: this.textInput }
                            )
                        });

                        if (!response.ok) {
                            let errorMessage = 'Failed to generate thread. Please try again.';
                            
                            try {
                                const errorData = await response.json();
                                
                                // Handle 401 Unauthorized - try refresh token first
                                if (response.status === 401) {
                                    if (this.getRefreshToken()) {
                                        try {
                                            console.log('401 error, attempting token refresh...');
                                            await this.refreshAccessToken();
                                            // Retry the original request with new token
                                            console.log('Token refreshed, retrying request...');
                                            return await this.generateThread();
                                        } catch (refreshError) {
                                            console.error('Token refresh failed:', refreshError);
                                            this.clearAuthData();
                                            this.showAuthModal('login');
                                            this.authError = 'Session expired. Please log in again.';
                                            return;
                                        }
                                    } else {
                                        this.clearAuthData();
                                        this.showAuthModal('login');
                                        this.authError = 'Please log in to continue';
                                        return;
                                    }
                                }
                                
                                // Handle 402 Payment Required specifically
                                if (response.status === 402) {
                                    this.showPaymentRequired(errorData);
                                    return;
                                }
                                
                                errorMessage = errorData.detail || errorData.message || errorMessage;
                            } catch (parseError) {
                                if (response.status === 401) {
                                    this.clearAuthData();
                                    this.showAuthModal('login');
                                    this.authError = 'Please log in to continue';
                                    return;
                                } else if (response.status === 429) {
                                    errorMessage = 'Rate limit exceeded. Please try again later.';
                                } else if (response.status === 402) {
                                    errorMessage = "You've reached your daily limit of 5 free threads. Upgrade to premium for unlimited access!";
                                } else if (response.status >= 500) {
                                    errorMessage = 'Server error. Please try again in a moment.';
                                }
                            }
                            
                            throw new Error(errorMessage);
                        }

                        const data = await response.json();
                        
                        if (!data || !data.thread || !Array.isArray(data.thread)) {
                            throw new Error('Invalid response format from server.');
                        }

                        this.tweets = data.thread.map(tweet => ({
                            text: tweet.content || tweet.text || '',
                            copied: false
                        }));

                        if (this.tweets.length === 0) {
                            throw new Error('No tweets were generated. Please try with different content.');
                        }

                        // Save thread to history if user is authenticated
                        if (this.isAuthenticated() && data.thread_id) {
                            // Thread should be automatically saved by backend
                            // Optionally refresh history if we're on history page
                            if (this.currentPage === 'history') {
                                this.loadThreadHistory();
                            }
                        }

                    } catch (error) {
                        console.error('Thread generation error:', error);
                        this.error = error.message || 'An unexpected error occurred. Please try again.';

                        // Fallback to demo tweets in development
                        if (window.location.hostname === 'localhost') {
                            console.log('Falling back to demo tweets');
                            this.generateMockTweets();
                            this.error = 'Demo mode: ' + this.error;
                        }
                    } finally {
                        this.loading = false;
                    }
                },

                generateMockTweets() {
                    this.tweets = [
                        {
                            text: "🧵 Here's an interesting article I found that's worth sharing. Let me break it down for you in this thread.",
                            copied: false
                        },
                        {
                            text: "The main point revolves around innovation and how it's changing our daily lives. The insights are quite compelling.",
                            copied: false
                        },
                        {
                            text: "What struck me most was the emphasis on adaptability. In today's fast-paced world, being able to pivot quickly is crucial.",
                            copied: false
                        },
                        {
                            text: "Key takeaway: Success isn't just about having great ideas, it's about execution and timing. Both matter equally.",
                            copied: false
                        }
                    ];
                },

                async showPaymentRequired(errorData) {
                    this.paymentData = errorData;
                    
                    // Fetch payment configuration from backend
                    try {
                        const response = await fetch(`${config.API_URL}/api/payment/config`, {
                            method: 'GET',
                            headers: this.getHeaders(),
                            mode: 'cors',
                            credentials: 'omit'
                        });
                        
                        if (response.ok) {
                            this.paymentConfig = await response.json();
                        }
                    } catch (error) {
                        console.error('Failed to fetch payment config:', error);
                    }
                    
                    this.showPaymentModal = true;
                    this.loading = false;
                    
                    // Also set a user-friendly error message as fallback
                    this.error = `You've reached your daily limit of ${errorData.limit || 5} free threads. Upgrade to premium for unlimited access!`;
                },

                async upgradeNow() {
                    // Use payment URL from config, fallback to paymentData
                    const paymentUrl = this.paymentConfig?.payment_url || this.paymentData?.upgrade_url;
                    
                    if (paymentUrl && paymentUrl !== '#') {
                        window.open(paymentUrl, '_blank');
                        this.closePaymentModal();
                    } else {
                        console.error('No payment URL available');
                        // Don't set error here - the button should be disabled instead
                        // this.error = 'Payment system not configured. Please try again later.';
                    }
                },

                closePaymentModal() {
                    this.showPaymentModal = false;
                    this.paymentData = null;
                    this.paymentConfig = null;
                },

                updateTweet(index, event) {
                    this.tweets[index].text = event.target.innerText;
                },

                validateTweetLength(index) {
                    if (this.tweets[index].text.length > 280) {
                        this.error = `Tweet ${index + 1} exceeds 280 characters. Please shorten it.`;
                    } else {
                        this.error = '';
                    }
                },

                async copyTweet(index) {
                    try {
                        await navigator.clipboard.writeText(this.tweets[index].text);
                        this.tweets[index].copied = true;
                        setTimeout(() => {
                            this.tweets[index].copied = false;
                        }, 2000);
                    } catch (err) {
                        this.error = 'Failed to copy tweet';
                    }
                },

                async copyAllTweets() {
                    try {
                        const allTweets = this.tweets.map((tweet, index) => 
                            `${index + 1}/${this.tweets.length}\n${tweet.text}`
                        ).join('\n\n');
                        
                        await navigator.clipboard.writeText(allTweets);
                        this.copiedAll = true;
                        setTimeout(() => {
                            this.copiedAll = false;
                        }, 2000);
                    } catch (err) {
                        this.error = 'Failed to copy thread';
                    }
                },

                // Page navigation
                switchToPage(page) {
                    this.currentPage = page;
                    this.sidebarOpen = false; // Close mobile sidebar
                    
                    if (page === 'history') {
                        this.loadThreadHistory();
                    }
                },

                // History functions
                async loadThreadHistory() {
                    if (!this.isAuthenticated()) {
                        this.historyError = 'Please log in to view your thread history';
                        return;
                    }

                    this.historyLoading = true;
                    this.historyError = '';

                    try {
                        const response = await fetch(`${config.API_URL}/api/threads`, {
                            method: 'GET',
                            headers: this.getHeaders(),
                            mode: 'cors',
                            credentials: 'omit'
                        });

                        if (!response.ok) {
                            if (response.status === 401) {
                                // Try to refresh token
                                if (this.getRefreshToken()) {
                                    try {
                                        await this.refreshAccessToken();
                                        return await this.loadThreadHistory(); // Retry
                                    } catch (refreshError) {
                                        this.clearAuthData();
                                        this.historyError = 'Session expired. Please log in again.';
                                        return;
                                    }
                                } else {
                                    this.clearAuthData();
                                    this.historyError = 'Please log in to view your history';
                                    return;
                                }
                            }
                            throw new Error('Failed to load thread history');
                        }

                        const data = await response.json();
                        this.threadHistory = data.threads || [];
                    } catch (error) {
                        console.error('Failed to load thread history:', error);
                        this.historyError = error.message || 'Failed to load thread history';
                    } finally {
                        this.historyLoading = false;
                    }
                },

                filteredThreads() {
                    if (!this.searchQuery) {
                        return this.threadHistory;
                    }
                    
                    const query = this.searchQuery.toLowerCase();
                    return this.threadHistory.filter(thread => 
                        (thread.title && thread.title.toLowerCase().includes(query)) ||
                        (thread.preview && thread.preview.toLowerCase().includes(query)) ||
                        (thread.source_url && thread.source_url.toLowerCase().includes(query))
                    );
                },

                debounceSearch() {
                    if (this.searchTimeout) {
                        clearTimeout(this.searchTimeout);
                    }
                    this.searchTimeout = setTimeout(() => {
                        // Search is handled by filteredThreads() reactively
                    }, 300);
                },

                formatDate(dateString) {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    const now = new Date();
                    const diffTime = Math.abs(now - date);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 1) return 'Today';
                    if (diffDays === 2) return 'Yesterday';
                    if (diffDays <= 7) return `${diffDays - 1} days ago`;
                    
                    return date.toLocaleDateString();
                },

                async viewThread(thread) {
                    try {
                        // Fetch full thread details if not already loaded
                        if (!thread.tweets) {
                            const response = await fetch(`${config.API_URL}/api/threads/${thread.id}`, {
                                method: 'GET',
                                headers: this.getHeaders(),
                                mode: 'cors',
                                credentials: 'omit'
                            });

                            if (response.ok) {
                                const fullThread = await response.json();
                                thread.tweets = fullThread.tweets;
                            }
                        }
                        
                        this.selectedThread = thread;
                        this.showThreadModal = true;
                    } catch (error) {
                        console.error('Failed to load thread details:', error);
                        this.historyError = 'Failed to load thread details';
                    }
                },

                closeThreadModal() {
                    this.showThreadModal = false;
                    this.selectedThread = null;
                },

                async copyThread(thread) {
                    if (!thread) return;
                    
                    try {
                        let tweetsText = '';
                        
                        if (thread.tweets && Array.isArray(thread.tweets)) {
                            tweetsText = thread.tweets.map((tweet, index) => 
                                `${index + 1}/${thread.tweets.length}\n${tweet.content || tweet.text}`
                            ).join('\n\n');
                        } else if (thread.preview) {
                            tweetsText = thread.preview;
                        } else {
                            tweetsText = thread.title || 'Thread content not available';
                        }
                        
                        await navigator.clipboard.writeText(tweetsText);
                        
                        // Track copy action with backend if thread has ID
                        if (thread.id) {
                            try {
                                await fetch(`${config.API_URL}/api/threads/${thread.id}/copy`, {
                                    method: 'POST',
                                    headers: this.getHeaders(),
                                    mode: 'cors',
                                    credentials: 'omit'
                                });
                            } catch (trackError) {
                                // Don't fail the copy operation if tracking fails
                                console.error('Failed to track copy action:', trackError);
                            }
                        }
                        
                        // Show success feedback
                        thread.copied = true;
                        setTimeout(() => {
                            thread.copied = false;
                        }, 2000);
                        
                    } catch (err) {
                        console.error('Failed to copy thread:', err);
                        this.historyError = 'Failed to copy thread';
                    }
                },

                async copyTweetFromModal(tweet, index) {
                    try {
                        await navigator.clipboard.writeText(tweet.content || tweet.text);
                        tweet.copied = true;
                        setTimeout(() => {
                            tweet.copied = false;
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy tweet:', err);
                    }
                },

                async toggleFavorite(thread) {
                    if (!thread.id) return;
                    
                    try {
                        const response = await fetch(`${config.API_URL}/api/threads/${thread.id}`, {
                            method: 'PATCH',
                            headers: this.getHeaders(),
                            mode: 'cors',
                            credentials: 'omit',
                            body: JSON.stringify({
                                is_favorite: !thread.is_favorite
                            })
                        });

                        if (response.ok) {
                            thread.is_favorite = !thread.is_favorite;
                        } else {
                            throw new Error('Failed to update favorite status');
                        }
                    } catch (error) {
                        console.error('Failed to toggle favorite:', error);
                        this.historyError = 'Failed to update favorite status';
                    }
                },

                async deleteThread(thread) {
                    if (!thread.id) return;
                    
                    if (!confirm('Are you sure you want to delete this thread? This action cannot be undone.')) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`${config.API_URL}/api/threads/${thread.id}`, {
                            method: 'DELETE',
                            headers: this.getHeaders(),
                            mode: 'cors',
                            credentials: 'omit'
                        });

                        if (response.ok) {
                            // Remove from local array
                            this.threadHistory = this.threadHistory.filter(t => t.id !== thread.id);
                            
                            // Close modal if this thread was being viewed
                            if (this.selectedThread && this.selectedThread.id === thread.id) {
                                this.closeThreadModal();
                            }
                        } else {
                            throw new Error('Failed to delete thread');
                        }
                    } catch (error) {
                        console.error('Failed to delete thread:', error);
                        this.historyError = 'Failed to delete thread';
                    }
                }
            }
        }
    </script>
</body>
</html>