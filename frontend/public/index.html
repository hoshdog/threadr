<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CACHE BUSTER: v1.2.0 - Force cache invalidation -->
    <title>Threadr - Convert Articles to Twitter/X Threads - Cache Fixed</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="icon" type="image/png" href="/logos/threadrLogo_Black.png">
    <link rel="apple-touch-icon" href="/logos/threadrLogo_Black.png">
    <script src="config.js?v=1.2.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'x-black': '#000000',
                        'x-dark': '#15202b',
                        'x-darker': '#192734', 
                        'x-darkest': '#22303c',
                        'x-gray': '#8899ac',
                        'x-light-gray': '#e1e8ed',
                        'x-blue': '#1d9bf0',
                        'x-blue-hover': '#1a8cd8',
                        'x-border': '#38444d',
                        'x-hover': '#1d2d3a'
                    },
                    fontFamily: {
                        'inter': ['Inter', 'system-ui', '-apple-system', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        * {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        body {
            background-color: #000000;
            color: #ffffff;
        }
        .tweet-editor:focus { 
            outline: none; 
            background-color: #0a0a0a;
        }
        .loading-spinner {
            border: 2px solid #38444d;
            border-top: 2px solid #1d9bf0;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .logo-pulse {
            animation: logoPulse 2s ease-in-out infinite;
        }
        @keyframes logoPulse {
            0%, 100% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }
        .logo-loading {
            animation: logoLoading 1.5s ease-in-out infinite;
        }
        @keyframes logoLoading {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        .sidebar-transition {
            transition: all 0.2s ease-in-out;
        }
        .nav-item {
            transition: all 0.2s ease-in-out;
        }
        .nav-item:hover {
            background-color: #1d2d3a;
        }
        .glass-effect {
            backdrop-filter: blur(12px);
            background-color: rgba(0, 0, 0, 0.8);
        }
        .tweet-card {
            background-color: #000000;
            border: 1px solid #2f3336;
            transition: all 0.2s ease-in-out;
        }
        .tweet-card:hover {
            border-color: #536471;
        }
        .button-primary {
            background-color: #1d9bf0;
            transition: all 0.2s ease-in-out;
        }
        .button-primary:hover {
            background-color: #1a8cd8;
        }
        .button-secondary {
            background-color: #0f1419;
            border: 1px solid #536471;
            transition: all 0.2s ease-in-out;
        }
        .button-secondary:hover {
            background-color: #1d2d3a;
        }
        .form-input {
            background-color: #000000;
            border: 1px solid #333639;
            color: #ffffff;
            transition: all 0.2s ease-in-out;
        }
        .form-input:focus {
            border-color: #1d9bf0;
            box-shadow: 0 0 0 1px #1d9bf0;
        }
        .form-input::placeholder {
            color: #71767b;
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* X/Twitter Preview Enhancements */
        .x-preview-tweet {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        .x-thread-line {
            background: linear-gradient(to bottom, transparent 0%, #38444d 20%, #38444d 80%, transparent 100%);
        }
        
        .x-engagement-btn {
            transition: all 0.2s ease-in-out;
        }
        
        /* Alpine.js cloak - CRITICAL: Hide elements before Alpine.js loads */
        [x-cloak] {
            display: none !important;
        }
        
        .x-engagement-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }
        
        .x-avatar-verified {
            background: linear-gradient(135deg, #1d9bf0 0%, #8b5cf6 100%);
            box-shadow: 0 2px 8px rgba(29, 155, 240, 0.3);
        }
    </style>
</head>
<body class="bg-x-black text-white min-h-screen font-inter">
    <!-- Mobile Header -->
    <div class="lg:hidden flex items-center justify-between p-4 border-b border-x-border">
        <div class="flex items-center space-x-3">
            <img src="/logos/threadrLogo_Black.png" alt="Threadr Logo" class="w-8 h-8">
            <h1 class="text-xl font-bold">Threadr</h1>
        </div>
        <button @click="sidebarOpen = !sidebarOpen" class="p-2 rounded-full hover:bg-x-hover">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
        </button>
    </div>

    <div x-data="threadrApp()" x-init="init()" class="flex min-h-screen">
        <!-- Sidebar -->
        <div class="sidebar-transition fixed lg:relative inset-y-0 left-0 z-50 w-64 lg:w-72 transform lg:transform-none" 
             :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'">
            <div class="glass-effect lg:bg-x-black h-full border-r border-x-border flex flex-col">
                <!-- Logo -->
                <div class="p-6 border-b border-x-border">
                    <div class="flex items-center space-x-3">
                        <img src="/logos/threadrLogo_White.png" alt="Threadr Logo" class="h-8 w-auto transition-all duration-200 hover:scale-105 cursor-pointer">
                        <div>
                            <h2 class="text-xl font-bold text-white">Threadr</h2>
                        </div>
                    </div>
                    <p class="text-x-gray text-sm mt-2">Convert articles to Twitter/X threads</p>
                </div>

                <!-- Navigation -->
                <nav class="flex-1 p-4 space-y-2">
                    <div 
                        @click="switchToPage('generate')"
                        :class="currentPage === 'generate' ? 'bg-x-blue text-white' : 'text-x-gray hover:text-white'"
                        class="nav-item rounded-xl p-3 cursor-pointer"
                    >
                        <div class="flex items-center space-x-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"/>
                            </svg>
                            <span class="font-medium">Generate Thread</span>
                        </div>
                    </div>
                    
                    <div 
                        @click="switchToPage('templates')"
                        :class="currentPage === 'templates' ? 'bg-x-blue text-white' : 'text-x-gray hover:text-white'"
                        class="nav-item rounded-xl p-3 cursor-pointer"
                    >
                        <div class="flex items-center space-x-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 00-2 2v2m0 0V9a2 2 0 012-2h14a2 2 0 012 2v2M7 7V5a2 2 0 012-2h6a2 2 0 012 2v2"/>
                            </svg>
                            <span class="font-medium">Templates</span>
                        </div>
                    </div>
                    
                    <div 
                        @click="switchToPage('history')"
                        :class="currentPage === 'history' ? 'bg-x-blue text-white' : 'text-x-gray hover:text-white'"
                        class="nav-item rounded-xl p-3 cursor-pointer"
                    >
                        <div class="flex items-center space-x-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span class="font-medium">History</span>
                        </div>
                    </div>
                    
                    <div 
                        @click="switchToPage('analytics')"
                        :class="currentPage === 'analytics' ? 'bg-x-blue text-white' : 'text-x-gray hover:text-white'"
                        class="nav-item rounded-xl p-3 cursor-pointer"
                    >
                        <div class="flex items-center space-x-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            <span class="font-medium">Analytics</span>
                            <span x-show="!user?.premium" class="text-xs bg-amber-500 text-black px-2 py-1 rounded-full">Pro</span>
                        </div>
                    </div>
                </nav>

                <!-- User Section -->
                <div class="p-4 border-t border-x-border">
                    <div x-show="!user" class="space-y-2">
                        <button 
                            @click="showAuthModal('signup')"
                            class="w-full button-primary text-white font-semibold py-3 px-4 rounded-full"
                        >
                            Sign Up
                        </button>
                        <button 
                            @click="showAuthModal('login')"
                            class="w-full button-secondary text-white font-medium py-3 px-4 rounded-full"
                        >
                            Login
                        </button>
                    </div>
                    
                    <div x-show="user" class="relative" x-data="{ showDropdown: false }">
                        <button 
                            @click="showDropdown = !showDropdown"
                            class="w-full flex items-center space-x-3 p-3 rounded-xl hover:bg-x-hover transition-colors duration-200"
                        >
                            <div class="w-10 h-10 bg-x-blue rounded-full flex items-center justify-center text-white font-semibold">
                                <span x-text="user?.email?.charAt(0).toUpperCase()"></span>
                            </div>
                            <div class="flex-1 text-left">
                                <div class="text-white font-semibold text-sm" x-text="user?.email"></div>
                                <div class="text-x-gray text-xs">Free Plan</div>
                            </div>
                            <svg class="w-4 h-4 text-x-gray" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        
                        <div 
                            x-show="showDropdown" 
                            @click.away="showDropdown = false"
                            x-transition:enter="transition ease-out duration-100"
                            x-transition:enter-start="transform opacity-0 scale-95"
                            x-transition:enter-end="transform opacity-100 scale-100"
                            x-transition:leave="transition ease-in duration-75"
                            x-transition:leave-start="transform opacity-100 scale-100"
                            x-transition:leave-end="transform opacity-0 scale-95"
                            class="absolute bottom-full left-0 right-0 mb-2 bg-x-dark rounded-xl border border-x-border shadow-2xl py-2 z-50"
                        >
                            <button 
                                @click="logout(); showDropdown = false"
                                class="block w-full text-left px-4 py-3 text-white hover:bg-x-hover transition-colors duration-200"
                            >
                                <div class="flex items-center space-x-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                                    </svg>
                                    <span>Logout</span>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overlay for mobile -->
        <div x-show="sidebarOpen" 
             @click="sidebarOpen = false"
             x-transition:enter="transition-opacity ease-linear duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition-opacity ease-linear duration-300"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden"></div>

        <!-- Main Content -->
        <div class="flex-1 lg:ml-0">
            <div class="max-w-2xl mx-auto p-6 lg:p-8">
                <!-- Generate Thread Page -->
                <div x-show="currentPage === 'generate'" x-transition>
                    <!-- Header -->
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-white mb-2">Create Your Thread</h2>
                        <p class="text-x-gray">Transform any article or content into an engaging Twitter/X thread</p>
                    </div>

                <!-- Main Form Card -->
                <div class="tweet-card rounded-2xl p-6 mb-6">
                    <!-- Input Type Toggle -->
                    <div class="flex justify-center mb-8">
                        <div class="inline-flex rounded-full bg-x-dark border border-x-border p-2">
                            <button 
                                @click="inputType = 'url'"
                                :class="inputType === 'url' ? 'bg-x-blue text-white' : 'text-x-gray hover:text-white'"
                                class="px-6 py-2 rounded-full font-semibold transition-all duration-200"
                            >
                                URL
                            </button>
                            <button 
                                @click="inputType = 'text'"
                                :class="inputType === 'text' ? 'bg-x-blue text-white' : 'text-x-gray hover:text-white'"
                                class="px-6 py-2 rounded-full font-semibold transition-all duration-200"
                            >
                                Paste Text
                            </button>
                        </div>
                    </div>

                    <!-- URL Input -->
                    <div x-show="inputType === 'url'" x-transition>
                        <label class="block text-sm font-semibold text-white mb-3">Article URL</label>
                        <input 
                            type="url" 
                            x-model="urlInput"
                            id="url-input"
                            placeholder="https://medium.com/article-title"
                            class="form-input w-full px-4 py-4 rounded-xl text-lg"
                            @keyup.enter="generateThread()"
                            @input="urlInput = $event.target.value"
                            @paste="setTimeout(() => { urlInput = $event.target.value }, 10)"
                        >
                        <p class="text-x-gray text-sm mt-2">Supports Medium, Dev.to, Substack, and more</p>
                    </div>

                    <!-- Text Input -->
                    <div x-show="inputType === 'text'" x-transition>
                        <label class="block text-sm font-semibold text-white mb-3">Paste your content</label>
                        <textarea 
                            x-model="textInput"
                            id="text-input"
                            placeholder="Paste your article content here..."
                            rows="8"
                            class="form-input w-full px-4 py-4 rounded-xl text-lg resize-none"
                            @input="textInput = $event.target.value"
                            @paste="setTimeout(() => { textInput = $event.target.value }, 10)"
                        ></textarea>
                        <p class="text-x-gray text-sm mt-2">Paste any text content to convert into a thread</p>
                    </div>

                    <!-- Generate Button -->
                    <button 
                        @click="generateThread()"
                        :disabled="loading || (!urlInput && inputType === 'url') || (!textInput && inputType === 'text')"
                        class="w-full mt-8 button-primary text-white font-bold py-4 px-8 rounded-full text-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span x-show="!loading" class="flex items-center justify-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            <span>Generate Thread</span>
                        </span>
                        <span x-show="loading" class="flex items-center justify-center space-x-3">
                            <div class="w-5 h-5 logo-loading">
                                <img src="/logos/threadrLogo_Black.png" alt="Loading..." class="w-full h-full">
                            </div>
                            <span>Generating...</span>
                        </span>
                    </button>

                    <!-- Error Message -->
                    <div x-show="error" x-transition class="mt-6 p-4 bg-red-900/20 border border-red-800/30 rounded-xl">
                        <div class="flex items-center space-x-2">
                            <svg class="w-5 h-5 text-red-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p class="text-red-300" x-text="error"></p>
                        </div>
                    </div>
                </div>

                <!-- Generated Thread -->
                <div x-show="tweets.length > 0" x-transition class="tweet-card rounded-2xl p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-xl font-bold text-white">Your Thread</h2>
                            <p class="text-x-gray text-sm" x-show="viewMode === 'edit'">Edit any tweet by clicking on it</p>
                            <p class="text-x-gray text-sm" x-show="viewMode === 'preview'">Preview how your thread will appear on Twitter/X</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <!-- Edit/Preview Toggle -->
                            <div class="inline-flex rounded-full bg-x-dark border border-x-border p-1">
                                <button 
                                    @click="viewMode = 'edit'"
                                    :class="viewMode === 'edit' ? 'bg-x-blue text-white' : 'text-x-gray hover:text-white'"
                                    class="px-4 py-1.5 rounded-full font-medium text-sm transition-all duration-200"
                                >
                                    Edit
                                </button>
                                <button 
                                    @click="viewMode = 'preview'"
                                    :class="viewMode === 'preview' ? 'bg-x-blue text-white' : 'text-x-gray hover:text-white'"
                                    class="px-4 py-1.5 rounded-full font-medium text-sm transition-all duration-200"
                                >
                                    Preview
                                </button>
                            </div>
                            
                            <!-- Copy All Button -->
                            <button 
                                @click="copyAllTweets()"
                                class="button-secondary text-white font-semibold py-2 px-4 rounded-full flex items-center space-x-2"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                                <span x-show="!copiedAll">Copy All</span>
                                <span x-show="copiedAll">Copied!</span>
                            </button>
                        </div>
                    </div>

                    <!-- Edit Mode -->
                    <div x-show="viewMode === 'edit'" x-transition class="space-y-4">
                        <template x-for="(tweet, index) in tweets" :key="index">
                            <div class="bg-x-black border border-x-border rounded-xl p-4 hover:border-x-gray/50 transition-all duration-200">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs text-x-gray font-semibold bg-x-dark px-2 py-1 rounded-full" x-text="`${index + 1}/${tweets.length}`"></span>
                                        <div class="w-8 h-8 bg-x-blue rounded-full flex items-center justify-center p-1.5">
                                            <img src="/logos/threadrLogo_White.png" alt="Thread" class="w-full h-full">
                                        </div>
                                    </div>
                                    <button 
                                        @click="copyTweet(index)"
                                        class="text-xs text-x-blue hover:text-x-blue-hover font-semibold px-3 py-1 rounded-full border border-x-blue/20 hover:border-x-blue/40 transition-all duration-200"
                                    >
                                        <span x-show="!tweet.copied" class="flex items-center space-x-1">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                            </svg>
                                            <span>Copy</span>
                                        </span>
                                        <span x-show="tweet.copied" class="flex items-center space-x-1">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                            </svg>
                                            <span>Copied!</span>
                                        </span>
                                    </button>
                                </div>
                                <div 
                                    contenteditable="true"
                                    @input="updateTweet(index, $event)"
                                    @blur="validateTweetLength(index)"
                                    class="tweet-editor text-white leading-relaxed min-h-[80px] p-3 rounded-lg focus:bg-x-dark/50 transition-colors duration-200"
                                    x-text="tweet.text"
                                ></div>
                                <div class="mt-3 flex justify-between items-center">
                                    <div class="flex items-center space-x-4 text-x-gray">
                                        <div class="flex items-center space-x-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                            </svg>
                                            <span class="text-sm">0</span>
                                        </div>
                                        <div class="flex items-center space-x-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                            </svg>
                                            <span class="text-sm">0</span>
                                        </div>
                                        <div class="flex items-center space-x-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                            </svg>
                                            <span class="text-sm">0</span>
                                        </div>
                                    </div>
                                    <div class="text-sm" :class="tweet.text.length > 280 ? 'text-red-400' : 'text-x-gray'">
                                        <span x-text="tweet.text.length"></span><span class="text-x-gray">/280</span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Preview Mode - X/Twitter Style -->
                    <div x-show="viewMode === 'preview'" x-transition class="space-y-0">
                        <!-- Thread container with X styling -->
                        <div class="bg-x-black border border-x-border rounded-2xl overflow-hidden">
                            <template x-for="(tweet, index) in tweets" :key="index">
                                <div class="relative x-preview-tweet">
                                    <!-- Thread connecting line (except for last tweet) -->
                                    <div x-show="index < tweets.length - 1" class="absolute left-[52px] top-[72px] w-0.5 h-full x-thread-line z-0"></div>
                                    
                                    <!-- Tweet container -->
                                    <div :class="index === 0 ? '' : 'border-t border-x-border/30'" class="p-4 hover:bg-x-hover/20 transition-all duration-200 relative z-10">
                                        <div class="flex space-x-3">
                                            <!-- Avatar -->
                                            <div class="flex-shrink-0">
                                                <div class="w-10 h-10 x-avatar-verified rounded-full flex items-center justify-center">
                                                    <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="currentColor">
                                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                                    </svg>
                                                </div>
                                            </div>
                                            
                                            <!-- Tweet content -->
                                            <div class="flex-1 min-w-0">
                                                <!-- Header -->
                                                <div class="flex items-center space-x-1 mb-1">
                                                    <span class="font-bold text-white text-[15px] hover:underline cursor-pointer">Your Name</span>
                                                    <svg class="w-4 h-4 text-x-blue flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                                                        <path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.26 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.45 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"/>
                                                    </svg>
                                                    <span class="text-x-gray text-[15px] hover:underline cursor-pointer">@yourhandle</span>
                                                    <span class="text-x-gray text-[15px]">·</span>
                                                    <span class="text-x-gray text-[15px] hover:underline cursor-pointer">now</span>
                                                    <div class="flex-1"></div>
                                                    <button class="text-x-gray hover:text-white p-1 rounded-full hover:bg-x-hover/50 transition-colors">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 12h.01M12 12h.01M18 12h.01"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                                
                                                <!-- Tweet text -->
                                                <div class="text-white text-[15px] leading-5 mb-3 whitespace-pre-wrap break-words" x-text="tweet.text"></div>
                                                
                                                <!-- Thread indicator for first tweet -->
                                                <div x-show="index === 0 && tweets.length > 1" class="text-x-blue text-[13px] mb-3 font-normal hover:underline cursor-pointer">
                                                    Show this thread
                                                </div>
                                                
                                                <!-- Engagement buttons -->
                                                <div class="flex items-center justify-between max-w-[425px] text-x-gray mt-3">
                                                    <!-- Reply -->
                                                    <button disabled class="x-engagement-btn flex items-center space-x-1 p-2 -ml-2 rounded-full hover:bg-x-blue/10 hover:text-x-blue transition-all group cursor-not-allowed opacity-75">
                                                        <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                                        </svg>
                                                        <span class="text-[13px] tabular-nums min-w-[8px]">0</span>
                                                    </button>
                                                    
                                                    <!-- Retweet -->
                                                    <button disabled class="x-engagement-btn flex items-center space-x-1 p-2 rounded-full hover:bg-green-500/10 hover:text-green-500 transition-all group cursor-not-allowed opacity-75">
                                                        <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                                        </svg>
                                                        <span class="text-[13px] tabular-nums min-w-[8px]">0</span>
                                                    </button>
                                                    
                                                    <!-- Like -->
                                                    <button disabled class="x-engagement-btn flex items-center space-x-1 p-2 rounded-full hover:bg-red-500/10 hover:text-red-500 transition-all group cursor-not-allowed opacity-75">
                                                        <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                                        </svg>
                                                        <span class="text-[13px] tabular-nums min-w-[8px]">0</span>
                                                    </button>
                                                    
                                                    <!-- Views -->
                                                    <button disabled class="x-engagement-btn flex items-center space-x-1 p-2 rounded-full hover:bg-x-blue/10 hover:text-x-blue transition-all group cursor-not-allowed opacity-75">
                                                        <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                                        </svg>
                                                        <span class="text-[13px] tabular-nums min-w-[20px]" x-text="Math.floor(Math.random() * 500) + 50"></span>
                                                    </button>
                                                    
                                                    <!-- Share/Bookmark -->
                                                    <div class="flex space-x-0">
                                                        <button disabled class="x-engagement-btn p-2 rounded-full hover:bg-x-blue/10 hover:text-x-blue transition-all cursor-not-allowed opacity-75">
                                                            <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"/>
                                                            </svg>
                                                        </button>
                                                        <button disabled class="x-engagement-btn p-2 rounded-full hover:bg-x-blue/10 hover:text-x-blue transition-all cursor-not-allowed opacity-75">
                                                            <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                <!-- Character count indicator in preview (subtle) -->
                                                <div class="mt-2 text-right">
                                                    <span class="text-xs px-2 py-1 rounded-full" 
                                                          :class="tweet.text.length > 280 ? 'bg-red-900/30 text-red-400 border border-red-600/30' : 
                                                                  tweet.text.length > 250 ? 'bg-yellow-900/30 text-yellow-400 border border-yellow-600/30' : 
                                                                  'bg-x-dark/50 text-x-gray border border-x-border/30'"
                                                          x-text="`${tweet.text.length}/280`">
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                        
                        <!-- Preview Mode Tips -->
                        <div class="mt-4 p-3 bg-x-dark/30 border border-x-border/50 rounded-xl">
                            <div class="flex items-start space-x-2 text-sm text-x-gray">
                                <svg class="w-4 h-4 text-x-blue flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <div>
                                    <p class="font-medium text-white mb-1">Preview Tips:</p>
                                    <ul class="space-y-1 text-xs">
                                        <li>• This shows exactly how your thread will appear on X/Twitter</li>
                                        <li>• Engagement buttons are disabled for preview</li>
                                        <li>• Switch to Edit mode to make changes</li>
                                        <li>• Red character counts indicate tweets over 280 characters</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>

                <!-- History Page -->
                <div x-show="currentPage === 'history'" x-transition>
                    <!-- Header -->
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-white mb-2">Thread History</h2>
                        <p class="text-x-gray">View and manage your saved threads</p>
                    </div>

                    <!-- Search Bar -->
                    <div class="tweet-card rounded-2xl p-6 mb-6">
                        <div class="relative">
                            <input 
                                type="text" 
                                x-model="searchQuery"
                                @input="debounceSearch()"
                                placeholder="Search your threads..."
                                class="form-input w-full px-4 py-4 pl-12 rounded-xl text-lg"
                            >
                            <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-x-gray" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div x-show="historyLoading" class="tweet-card rounded-2xl p-12 text-center">
                        <div class="mx-auto mb-4 w-8 h-8 logo-loading">
                            <img src="/logos/threadrLogo_Black.png" alt="Loading..." class="w-full h-full">
                        </div>
                        <p class="text-x-gray">Loading your threads...</p>
                    </div>

                    <!-- Error State -->
                    <div x-show="historyError && !historyLoading" class="tweet-card rounded-2xl p-6 mb-6">
                        <div class="flex items-center space-x-2 text-red-400">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p x-text="historyError"></p>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div x-show="!historyLoading && !historyError && threadHistory.length === 0" class="tweet-card rounded-2xl p-12 text-center">
                        <div class="w-16 h-16 bg-x-dark rounded-full flex items-center justify-center mx-auto mb-6">
                            <svg class="w-8 h-8 text-x-gray" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-2">No threads yet</h3>
                        <p class="text-x-gray mb-6">Create your first thread to see it here</p>
                        <button 
                            @click="switchToPage('generate')"
                            class="button-primary text-white font-semibold py-3 px-6 rounded-full"
                        >
                            Create Thread
                        </button>
                    </div>

                    <!-- Thread List -->
                    <div x-show="!historyLoading && !historyError && threadHistory.length > 0" class="space-y-4">
                        <template x-for="thread in filteredThreads()" :key="thread.id">
                            <div class="tweet-card rounded-2xl p-6 hover:border-x-gray/50 transition-all duration-200">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex-1">
                                        <h3 class="text-lg font-semibold text-white mb-2 cursor-pointer hover:text-x-blue transition-colors" 
                                            @click="viewThread(thread)" 
                                            x-text="thread.title || 'Untitled Thread'">
                                        </h3>
                                        <div class="flex items-center space-x-4 text-sm text-x-gray">
                                            <span x-text="formatDate(thread.created_at)"></span>
                                            <span x-text="`${thread.tweet_count} tweets`"></span>
                                            <span x-show="thread.source_url" class="truncate max-w-xs">
                                                <span x-text="thread.source_url"></span>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2 ml-4">
                                        <!-- Favorite Button -->
                                        <button 
                                            @click="toggleFavorite(thread)"
                                            :class="thread.is_favorite ? 'text-yellow-400' : 'text-x-gray hover:text-yellow-400'"
                                            class="p-2 rounded-full hover:bg-x-hover transition-colors"
                                        >
                                            <svg class="w-5 h-5" :fill="thread.is_favorite ? 'currentColor' : 'none'" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                                            </svg>
                                        </button>
                                        <!-- Copy Thread Button -->
                                        <button 
                                            @click="copyThread(thread)"
                                            class="p-2 rounded-full text-x-gray hover:text-x-blue hover:bg-x-hover transition-colors"
                                        >
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                            </svg>
                                        </button>
                                        <!-- Delete Button -->
                                        <button 
                                            @click="deleteThread(thread)"
                                            class="p-2 rounded-full text-x-gray hover:text-red-400 hover:bg-x-hover transition-colors"
                                        >
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Thread Preview -->
                                <div class="text-x-gray text-sm line-clamp-2" x-text="thread.preview"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Thread Detail Modal -->
        <div 
            x-show="showThreadModal" 
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"
            @click.self="closeThreadModal()"
        >
            <div 
                x-show="showThreadModal"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 transform scale-95"
                x-transition:enter-end="opacity-100 transform scale-100"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 transform scale-100"
                x-transition:leave-end="opacity-0 transform scale-95"
                class="bg-x-black border border-x-border rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden"
            >
                <!-- Modal Header -->
                <div class="flex justify-between items-center p-6 border-b border-x-border">
                    <div>
                        <h3 class="text-xl font-bold text-white" x-text="selectedThread?.title || 'Thread Details'"></h3>
                        <div class="flex items-center space-x-4 text-sm text-x-gray mt-1">
                            <span x-text="formatDate(selectedThread?.created_at)"></span>
                            <span x-text="`${selectedThread?.tweet_count} tweets`"></span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <!-- Copy Thread Button -->
                        <button 
                            @click="copyThread(selectedThread)"
                            class="p-2 rounded-full text-x-gray hover:text-x-blue hover:bg-x-hover transition-colors"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                        </button>
                        <!-- Close Button -->
                        <button 
                            @click="closeThreadModal()"
                            class="p-2 rounded-full text-x-gray hover:text-white hover:bg-x-hover transition-colors"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Modal Content -->
                <div class="p-6 overflow-y-auto max-h-[calc(90vh-8rem)]">
                    <template x-if="selectedThread && selectedThread.tweets">
                        <div class="space-y-4">
                            <template x-for="(tweet, index) in selectedThread.tweets" :key="index">
                                <div class="bg-x-dark rounded-xl p-4">
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex items-center space-x-2">
                                            <span class="text-xs text-x-gray font-semibold bg-x-black px-2 py-1 rounded-full" x-text="`${index + 1}/${selectedThread.tweets.length}`"></span>
                                            <div class="w-8 h-8 bg-x-blue rounded-full flex items-center justify-center p-1.5">
                                                <img src="/logos/threadrLogo_White.png" alt="Thread" class="w-full h-full">
                                            </div>
                                        </div>
                                        <button 
                                            @click="copyTweetFromModal(tweet, index)"
                                            class="text-xs text-x-blue hover:text-x-blue-hover font-semibold px-3 py-1 rounded-full border border-x-blue/20 hover:border-x-blue/40 transition-all duration-200"
                                        >
                                            <span x-show="!tweet.copied" class="flex items-center space-x-1">
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                                </svg>
                                                <span>Copy</span>
                                            </span>
                                            <span x-show="tweet.copied" class="flex items-center space-x-1">
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                </svg>
                                                <span>Copied!</span>
                                            </span>
                                        </button>
                                    </div>
                                    <div class="text-white leading-relaxed" x-text="tweet.content || tweet.text"></div>
                                    <div class="mt-3 text-sm text-x-gray">
                                        <span x-text="(tweet.content || tweet.text).length"></span><span>/280</span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Authentication Modal -->
        <div 
            x-cloak
            x-show="authModalVisible" 
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"
            @click.self="closeAuthModal()"
        >
            <div 
                x-show="authModalVisible"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 transform scale-95"
                x-transition:enter-end="opacity-100 transform scale-100"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 transform scale-100"
                x-transition:leave-end="opacity-0 transform scale-95"
                class="bg-x-black border border-x-border rounded-2xl shadow-2xl p-8 max-w-md w-full"
            >
                <!-- Modal Header -->
                <div class="flex justify-between items-center mb-8">
                    <div class="flex items-center space-x-4">
                        <img src="/logos/threadrLogo_Black.png" alt="Threadr Logo" class="w-10 h-10">
                        <div>
                            <h3 class="text-2xl font-bold text-white" x-text="authMode === 'login' ? 'Welcome back' : 'Join Threadr'"></h3>
                            <p class="text-x-gray text-sm mt-1" x-text="authMode === 'login' ? 'Sign in to your account' : 'Create your account'"></p>
                        </div>
                    </div>
                    <button 
                        @click="closeAuthModal()"
                        class="text-x-gray hover:text-white transition-colors duration-200 p-2 rounded-full hover:bg-x-hover"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Auth Form -->
                <form @submit.prevent="handleAuth()" class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold text-white mb-3">Email</label>
                        <input 
                            type="email" 
                            x-model="authForm.email"
                            placeholder="your@email.com"
                            required
                            class="form-input w-full px-4 py-4 rounded-xl"
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-white mb-3">Password</label>
                        <input 
                            type="password" 
                            x-model="authForm.password"
                            placeholder="Password"
                            required
                            class="form-input w-full px-4 py-4 rounded-xl"
                        >
                    </div>
                    
                    <!-- Remember Me Checkbox (only for login) -->
                    <div x-show="authMode === 'login'" x-transition class="flex items-center">
                        <input 
                            type="checkbox" 
                            x-model="authForm.rememberMe"
                            id="remember-me"
                            class="w-4 h-4 text-x-blue bg-x-black border-x-border rounded focus:ring-x-blue focus:ring-2"
                        >
                        <label for="remember-me" class="ml-2 text-sm text-x-gray">
                            Keep me signed in for 30 days
                        </label>
                    </div>
                    
                    <!-- Confirm Password (only for signup) -->
                    <div x-show="authMode === 'signup'" x-transition>
                        <label class="block text-sm font-semibold text-white mb-3">Confirm Password</label>
                        <input 
                            type="password" 
                            x-model="authForm.confirmPassword"
                            placeholder="Confirm Password"
                            x-bind:required="authMode === 'signup'"
                            class="form-input w-full px-4 py-4 rounded-xl"
                        >
                    </div>
                    
                    <!-- Error Message -->
                    <div x-show="authError" x-transition class="p-4 bg-red-900/20 border border-red-800/30 rounded-xl">
                        <div class="flex items-center space-x-2">
                            <svg class="w-4 h-4 text-red-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p class="text-red-300 text-sm" x-text="authError"></p>
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <button 
                        type="submit"
                        :disabled="authLoading"
                        class="w-full button-primary text-white font-bold py-4 px-6 rounded-full disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span x-show="!authLoading" x-text="authMode === 'login' ? 'Sign In' : 'Create Account'"></span>
                        <span x-show="authLoading" class="flex items-center justify-center space-x-2">
                            <div class="w-5 h-5 logo-loading">
                                <img src="/logos/threadrLogo_Black.png" alt="Loading..." class="w-full h-full">
                            </div>
                            <span x-text="authMode === 'login' ? 'Signing in...' : 'Creating account...'"></span>
                        </span>
                    </button>
                </form>
                
                <!-- Toggle Auth Mode -->
                <div class="mt-8 text-center">
                    <p class="text-x-gray">
                        <span x-text="authMode === 'login' ? 'Don\'t have an account?' : 'Already have an account?'"></span>
                        <button 
                            @click="toggleAuthMode()"
                            class="text-x-blue hover:text-x-blue-hover font-semibold ml-2 transition-colors duration-200"
                            x-text="authMode === 'login' ? 'Sign up' : 'Sign in'"
                        ></button>
                    </p>
                </div>
            </div>
        </div>

        <!-- Payment Required Modal -->
        <div 
            x-cloak
            x-show="showPaymentModal" 
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"
            @click.self="closePaymentModal()"
            @keydown.escape.window="closePaymentModal()"
        >
            <div 
                x-show="showPaymentModal"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 transform scale-95"
                x-transition:enter-end="opacity-100 transform scale-100"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 transform scale-100"
                x-transition:leave-end="opacity-0 transform scale-95"
                class="bg-x-black border border-x-border rounded-2xl shadow-2xl p-8 max-w-md w-full"
            >
                <!-- Close Button -->
                <div class="flex justify-end mb-4">
                    <button 
                        @click="closePaymentModal()"
                        class="text-x-gray hover:text-white transition-colors duration-200 p-2 rounded-full hover:bg-x-hover"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="text-center">
                    <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 mb-6 p-3">
                        <img src="/logos/threadrLogo_White.png" alt="Threadr Logo" class="w-full h-full">
                    </div>
                    
                    <h3 class="text-2xl font-bold text-white mb-2">Upgrade to Premium</h3>
                    
                    <p class="text-x-gray mb-6">
                        You've reached your daily limit of <span class="text-white font-semibold" x-text="paymentData?.limit || 5"></span> free threads.
                    </p>
                    
                    <div x-show="paymentData?.usage" class="bg-x-dark rounded-xl p-4 mb-6 text-sm">
                        <p class="text-x-gray">
                            Today's usage: <span class="text-white font-semibold" x-text="paymentData?.usage?.threads_today || 0"></span> / <span x-text="paymentData?.limit || 5"></span> threads
                        </p>
                        <p class="text-x-gray mt-1" x-show="paymentData?.usage?.total_threads">
                            Total threads created: <span class="text-white font-semibold" x-text="paymentData?.usage?.total_threads"></span>
                        </p>
                    </div>
                    
                    <div class="mb-8">
                        <h4 class="font-semibold text-white mb-4">Premium Benefits:</h4>
                        <ul class="text-sm text-x-gray text-left space-y-3">
                            <li class="flex items-center space-x-3">
                                <div class="w-5 h-5 bg-green-500 rounded-full flex items-center justify-center">
                                    <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </div>
                                <span>Unlimited threads per day</span>
                            </li>
                            <li class="flex items-center space-x-3">
                                <div class="w-5 h-5 bg-green-500 rounded-full flex items-center justify-center">
                                    <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </div>
                                <span>Priority processing</span>
                            </li>
                            <li class="flex items-center space-x-3">
                                <div class="w-5 h-5 bg-green-500 rounded-full flex items-center justify-center">
                                    <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </div>
                                <span>Advanced editing features</span>
                            </li>
                            <li class="flex items-center space-x-3">
                                <div class="w-5 h-5 bg-green-500 rounded-full flex items-center justify-center">
                                    <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </div>
                                <span>Export to multiple formats</span>
                            </li>
                        </ul>
                    </div>
                    
                    <div x-show="paymentData?.price" class="mb-8">
                        <div class="bg-gradient-to-r from-x-blue to-purple-600 rounded-xl p-4">
                            <p class="text-3xl font-bold text-white">
                                $<span x-text="paymentData?.price"></span><span class="text-lg font-normal text-white/80">/month</span>
                            </p>
                            <p class="text-white/80 text-sm mt-1">Cancel anytime</p>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button 
                            @click="closePaymentModal()"
                            class="flex-1 px-6 py-3 button-secondary text-white font-semibold rounded-full transition-colors duration-200"
                        >
                            Maybe Later
                        </button>
                        <button 
                            @click="upgradeNow()"
                            :disabled="!paymentConfig?.payment_url"
                            :class="paymentConfig?.payment_url ? 'button-primary' : 'bg-x-gray cursor-not-allowed'"
                            class="flex-1 px-6 py-3 text-white font-bold rounded-full transition-colors duration-200 text-center"
                        >
                            <span x-show="paymentConfig?.payment_url">Upgrade Now</span>
                            <span x-show="!paymentConfig?.payment_url">Coming Soon</span>
                        </button>
                    </div>
                    
                    <p class="text-xs text-x-gray mt-4">
                        Try again tomorrow for more free threads!
                    </p>
                </div>

                <!-- Analytics Page -->
                <div x-show="currentPage === 'analytics'" x-transition>
                    <!-- Premium Gate -->
                    <div x-show="!user?.premium" class="text-center py-12">
                        <div class="max-w-md mx-auto">
                            <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-r from-amber-500 to-orange-600 rounded-full flex items-center justify-center">
                                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-white mb-4">Analytics is a Pro Feature</h3>
                            <p class="text-x-gray mb-8">Get detailed insights into your thread performance, engagement metrics, and AI-powered recommendations.</p>
                            
                            <div class="space-y-4 mb-8">
                                <div class="flex items-center space-x-3 text-left">
                                    <div class="w-2 h-2 bg-x-blue rounded-full"></div>
                                    <span class="text-white">Detailed engagement metrics</span>
                                </div>
                                <div class="flex items-center space-x-3 text-left">
                                    <div class="w-2 h-2 bg-x-blue rounded-full"></div>
                                    <span class="text-white">Thread performance comparisons</span>
                                </div>
                                <div class="flex items-center space-x-3 text-left">
                                    <div class="w-2 h-2 bg-x-blue rounded-full"></div>
                                    <span class="text-white">AI-powered insights and tips</span>
                                </div>
                                <div class="flex items-center space-x-3 text-left">
                                    <div class="w-2 h-2 bg-x-blue rounded-full"></div>
                                    <span class="text-white">Industry benchmarking</span>
                                </div>
                            </div>
                            
                            <button class="bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white font-semibold py-4 px-8 rounded-full transition-all duration-200">
                                Upgrade to Pro
                            </button>
                        </div>
                    </div>

                    <!-- Analytics Dashboard (Premium Users) -->
                    <div x-show="user?.premium">
                        <!-- Header -->
                        <div class="mb-8">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
                                <div>
                                    <h2 class="text-2xl font-bold text-white mb-2">Analytics Dashboard</h2>
                                    <p class="text-x-gray">Track your thread performance and engagement</p>
                                </div>
                                
                                <!-- Time Period Selector -->
                                <div class="flex rounded-full bg-x-dark border border-x-border p-1">
                                    <button 
                                        @click="changeTimePeriod('1d')"
                                        :class="analyticsTimePeriod === '1d' ? 'bg-x-blue text-white' : 'text-x-gray hover:text-white'"
                                        class="px-4 py-2 rounded-full text-sm font-medium transition-all duration-200"
                                    >
                                        24h
                                    </button>
                                    <button 
                                        @click="changeTimePeriod('7d')"
                                        :class="analyticsTimePeriod === '7d' ? 'bg-x-blue text-white' : 'text-x-gray hover:text-white'"
                                        class="px-4 py-2 rounded-full text-sm font-medium transition-all duration-200"
                                    >
                                        7d
                                    </button>
                                    <button 
                                        @click="changeTimePeriod('30d')"
                                        :class="analyticsTimePeriod === '30d' ? 'bg-x-blue text-white' : 'text-x-gray hover:text-white'"
                                        class="px-4 py-2 rounded-full text-sm font-medium transition-all duration-200"
                                    >
                                        30d
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Loading State -->
                        <div x-show="analyticsLoading" class="flex items-center justify-center py-12">
                            <div class="loading-spinner"></div>
                            <span class="ml-3 text-x-gray">Loading analytics...</span>
                        </div>

                        <!-- Error State -->
                        <div x-show="analyticsError && !analyticsLoading" class="tweet-card rounded-2xl p-6 mb-6">
                            <div class="flex items-center space-x-3 text-red-400">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span x-text="analyticsError"></span>
                            </div>
                        </div>

                        <!-- Dashboard Content -->
                        <div x-show="!analyticsLoading && !analyticsError && analyticsData.dashboard">
                            <!-- Key Metrics Cards -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                                <!-- Total Impressions -->
                                <div class="tweet-card rounded-2xl p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <div class="w-12 h-12 bg-x-blue/20 rounded-full flex items-center justify-center">
                                            <svg class="w-6 h-6 text-x-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                            </svg>
                                        </div>
                                        <span :class="analyticsData.dashboard?.impressions_change >= 0 ? 'text-green-400' : 'text-red-400'" 
                                              class="text-sm font-medium"
                                              x-text="analyticsData.dashboard?.impressions_change >= 0 ? '+' + formatPercentage(analyticsData.dashboard?.impressions_change) : formatPercentage(analyticsData.dashboard?.impressions_change)">
                                        </span>
                                    </div>
                                    <h3 class="text-2xl font-bold text-white mb-1" x-text="formatNumber(analyticsData.dashboard?.total_impressions)"></h3>
                                    <p class="text-x-gray text-sm">Impressions</p>
                                </div>

                                <!-- Engagement Rate -->
                                <div class="tweet-card rounded-2xl p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <div class="w-12 h-12 bg-green-500/20 rounded-full flex items-center justify-center">
                                            <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                            </svg>
                                        </div>
                                        <span :class="analyticsData.dashboard?.engagement_change >= 0 ? 'text-green-400' : 'text-red-400'" 
                                              class="text-sm font-medium"
                                              x-text="analyticsData.dashboard?.engagement_change >= 0 ? '+' + formatPercentage(analyticsData.dashboard?.engagement_change) : formatPercentage(analyticsData.dashboard?.engagement_change)">
                                        </span>
                                    </div>
                                    <h3 class="text-2xl font-bold text-white mb-1" x-text="formatPercentage(analyticsData.dashboard?.avg_engagement_rate)"></h3>
                                    <p class="text-x-gray text-sm">Engagement Rate</p>
                                </div>

                                <!-- Total Threads -->
                                <div class="tweet-card rounded-2xl p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <div class="w-12 h-12 bg-purple-500/20 rounded-full flex items-center justify-center">
                                            <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                            </svg>
                                        </div>
                                        <span :class="analyticsData.dashboard?.threads_change >= 0 ? 'text-green-400' : 'text-red-400'" 
                                              class="text-sm font-medium"
                                              x-text="analyticsData.dashboard?.threads_change >= 0 ? '+' + analyticsData.dashboard?.threads_change : analyticsData.dashboard?.threads_change">
                                        </span>
                                    </div>
                                    <h3 class="text-2xl font-bold text-white mb-1" x-text="analyticsData.dashboard?.total_threads || 0"></h3>
                                    <p class="text-x-gray text-sm">Threads Created</p>
                                </div>

                                <!-- Avg Thread Length -->
                                <div class="tweet-card rounded-2xl p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <div class="w-12 h-12 bg-orange-500/20 rounded-full flex items-center justify-center">
                                            <svg class="w-6 h-6 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                            </svg>
                                        </div>
                                        <span class="text-x-gray text-sm">tweets</span>
                                    </div>
                                    <h3 class="text-2xl font-bold text-white mb-1" x-text="(analyticsData.dashboard?.avg_thread_length || 0).toFixed(1)"></h3>
                                    <p class="text-x-gray text-sm">Avg Thread Length</p>
                                </div>
                            </div>

                            <!-- Charts Section -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                                <!-- Engagement Over Time -->
                                <div class="tweet-card rounded-2xl p-6">
                                    <h3 class="text-lg font-semibold text-white mb-4">Engagement Over Time</h3>
                                    <div class="h-64">
                                        <canvas id="engagementChart"></canvas>
                                    </div>
                                </div>

                                <!-- Top Performing Threads -->
                                <div class="tweet-card rounded-2xl p-6">
                                    <h3 class="text-lg font-semibold text-white mb-4">Thread Performance</h3>
                                    <div class="h-64">
                                        <canvas id="performanceChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- Thread Performance Table -->
                            <div class="tweet-card rounded-2xl p-6 mb-8">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="text-lg font-semibold text-white">Thread Performance</h3>
                                    <div class="flex items-center space-x-2">
                                        <!-- <button 
                                            x-show="compareThreads.length === 2"
                                            @click="showComparison()"
                                            class="bg-x-blue hover:bg-x-blue-hover text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                                        >
                                            Compare Selected
                                        </button>
                                        <button 
                                            x-show="compareThreads.length > 0"
                                            @click="compareThreads = []"
                                            class="text-x-gray hover:text-white px-4 py-2 rounded-lg text-sm transition-colors"
                                        >
                                            Clear Selection
                                        </button> -->
                                    </div>
                                </div>

                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead>
                                            <tr class="border-b border-x-border">
                                                <th class="text-left py-3 px-4 text-x-gray font-medium">Thread</th>
                                                <th class="text-left py-3 px-4 text-x-gray font-medium">Engagement</th>
                                                <th class="text-left py-3 px-4 text-x-gray font-medium">Impressions</th>
                                                <th class="text-left py-3 px-4 text-x-gray font-medium">Rate</th>
                                                <th class="text-left py-3 px-4 text-x-gray font-medium">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template x-for="thread in analyticsData.threads?.slice(0, 10)" :key="thread.id">
                                                <tr class="border-b border-x-border/50 hover:bg-x-hover/30 transition-colors">
                                                    <td class="py-4 px-4">
                                                        <div class="flex items-center space-x-3">
                                                            <!-- <input 
                                                                type="checkbox"
                                                                :checked="compareThreads.find(t => t.id === thread.id)"
                                                                @change="$event.target.checked ? addToComparison(thread) : removeFromComparison(thread.id)"
                                                                :disabled="!$event.target.checked && compareThreads.length >= 2"
                                                                class="w-4 h-4 text-x-blue bg-x-black border-x-border rounded"
                                                            > -->
                                                            <div>
                                                                <p class="text-white font-medium cursor-pointer hover:text-x-blue transition-colors" 
                                                                   @click="selectAnalyticsThread(thread)"
                                                                   x-text="thread.title?.slice(0, 50) + '...' || 'Untitled Thread'">
                                                                </p>
                                                                <p class="text-x-gray text-sm" x-text="new Date(thread.created_at).toLocaleDateString()"></p>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="py-4 px-4">
                                                        <span class="text-white font-medium" x-text="formatNumber(thread.total_engagement)"></span>
                                                    </td>
                                                    <td class="py-4 px-4">
                                                        <span class="text-white font-medium" x-text="formatNumber(thread.impressions)"></span>
                                                    </td>
                                                    <td class="py-4 px-4">
                                                        <span :class="getEngagementColor(thread.engagement_rate)" 
                                                              class="font-medium"
                                                              x-text="formatPercentage(thread.engagement_rate)">
                                                        </span>
                                                        <span class="ml-1" x-text="getPerformanceIcon(thread.engagement_rate)"></span>
                                                    </td>
                                                    <td class="py-4 px-4">
                                                        <button 
                                                            @click="selectAnalyticsThread(thread)"
                                                            class="text-x-blue hover:text-x-blue-hover text-sm font-medium transition-colors"
                                                        >
                                                            View Details
                                                        </button>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- AI Insights Section -->
                            <div x-show="analyticsData.insights" class="tweet-card rounded-2xl p-6 mb-8">
                                <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                                    <svg class="w-5 h-5 text-x-blue mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                    </svg>
                                    AI Insights & Recommendations
                                </h3>
                                
                                <div class="space-y-4">
                                    <template x-for="insight in analyticsData.insights?.recommendations" :key="insight.id">
                                        <div class="flex items-start space-x-3 p-4 bg-x-dark/30 rounded-xl border border-x-border/30">
                                            <div class="w-2 h-2 bg-x-blue rounded-full mt-2 flex-shrink-0"></div>
                                            <div>
                                                <h4 class="text-white font-medium mb-1" x-text="insight.title"></h4>
                                                <p class="text-x-gray text-sm" x-text="insight.description"></p>
                                                <div x-show="insight.impact" class="mt-2">
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-900/30 text-green-400">
                                                        Potential Impact: <span x-text="insight.impact" class="ml-1"></span>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- Industry Benchmarks -->
                            <div x-show="analyticsData.benchmarks" class="tweet-card rounded-2xl p-6">
                                <h3 class="text-lg font-semibold text-white mb-4">Industry Benchmarks</h3>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-white mb-1" x-text="formatPercentage(analyticsData.benchmarks?.industry_avg_engagement)"></div>
                                        <div class="text-x-gray text-sm">Industry Average</div>
                                        <div class="mt-2">
                                            <span :class="(analyticsData.dashboard?.avg_engagement_rate || 0) > (analyticsData.benchmarks?.industry_avg_engagement || 0) ? 'text-green-400' : 'text-red-400'" 
                                                  class="text-sm font-medium">
                                                <span x-show="(analyticsData.dashboard?.avg_engagement_rate || 0) > (analyticsData.benchmarks?.industry_avg_engagement || 0)">Above average</span>
                                                <span x-show="(analyticsData.dashboard?.avg_engagement_rate || 0) <= (analyticsData.benchmarks?.industry_avg_engagement || 0)">Below average</span>
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-white mb-1" x-text="analyticsData.benchmarks?.top_performer_percentile"></div>
                                        <div class="text-x-gray text-sm">Your Percentile</div>
                                        <div class="mt-2">
                                            <span :class="(analyticsData.benchmarks?.top_performer_percentile || 0) >= 75 ? 'text-green-400' : 
                                                          (analyticsData.benchmarks?.top_performer_percentile || 0) >= 50 ? 'text-yellow-400' : 'text-red-400'" 
                                                  class="text-sm font-medium">
                                                <span x-show="(analyticsData.benchmarks?.top_performer_percentile || 0) >= 75">Top performer</span>
                                                <span x-show="(analyticsData.benchmarks?.top_performer_percentile || 0) >= 50 && (analyticsData.benchmarks?.top_performer_percentile || 0) < 75">Above average</span>
                                                <span x-show="(analyticsData.benchmarks?.top_performer_percentile || 0) < 50">Room for improvement</span>
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-white mb-1" x-text="(analyticsData.benchmarks?.optimal_thread_length || 0).toFixed(0)"></div>
                                        <div class="text-x-gray text-sm">Optimal Length</div>
                                        <div class="mt-2">
                                            <span class="text-x-gray text-sm">tweets for max engagement</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Templates Page -->
                <div x-show="currentPage === 'templates'" x-transition>
                    <!-- Header -->
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-white mb-2">Thread Templates</h2>
                        <p class="text-x-gray">Choose from proven thread formats to get started quickly</p>
                    </div>

                    <!-- Search and Filter Controls -->
                    <div class="mb-8">
                        <div class="flex flex-col sm:flex-row gap-4">
                            <!-- Search -->
                            <div class="flex-1">
                                <div class="relative">
                                    <input 
                                        type="text" 
                                        x-model="templateSearch"
                                        placeholder="Search templates..."
                                        class="w-full bg-x-dark border border-x-border rounded-xl px-4 py-3 pl-10 text-white placeholder-x-gray focus:outline-none focus:border-x-blue"
                                    />
                                    <svg class="w-5 h-5 text-x-gray absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                    </svg>
                                </div>
                            </div>
                            
                            <!-- Category Filter -->
                            <div class="sm:w-48">
                                <select 
                                    x-model="selectedCategory"
                                    class="w-full bg-x-dark border border-x-border rounded-xl px-4 py-3 text-white focus:outline-none focus:border-x-blue"
                                >
                                    <option value="all">All Categories</option>
                                    <option value="Business">Business</option>
                                    <option value="Educational">Educational</option>
                                    <option value="Personal">Personal</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Popular Templates Section -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <svg class="w-5 h-5 text-x-blue mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            Popular Templates
                            <span class="ml-2 text-sm text-x-gray">(<span x-text="getPopularTemplates().length"></span>)</span>
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <template x-for="template in getPopularTemplates()" :key="template.id">
                                <div class="tweet-card rounded-2xl p-6 hover:border-x-gray/50 transition-all duration-200 cursor-pointer"
                                     @click="selectTemplate(template)">
                                    <!-- Template Header -->
                                    <div class="flex justify-between items-start mb-3">
                                        <div>
                                            <h4 class="text-white font-medium mb-1" x-text="template.name"></h4>
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs px-2 py-1 rounded-full bg-x-blue/20 text-x-blue" x-text="template.category"></span>
                                                <span x-show="template.isPro" class="text-xs px-2 py-1 rounded-full bg-amber-500/20 text-amber-400">Pro</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center text-x-gray text-sm">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                            </svg>
                                            <span x-text="template.popularity + '%'"></span>
                                        </div>
                                    </div>
                                    
                                    <!-- Template Description -->
                                    <p class="text-x-gray text-sm mb-4" x-text="template.description"></p>
                                    
                                    <!-- Template Preview -->
                                    <div class="space-y-2">
                                        <template x-for="(tweet, index) in template.structure.slice(0, 3)" :key="index">
                                            <div class="text-xs text-x-gray bg-x-dark/50 rounded px-3 py-2 truncate" x-text="tweet.replace(/\{[^}]+\}/g, '...')"></div>
                                        </template>
                                        <div x-show="template.structure.length > 3" class="text-xs text-x-gray text-center">
                                            + <span x-text="template.structure.length - 3"></span> more tweets
                                        </div>
                                    </div>
                                    
                                    <!-- Use Template Button -->
                                    <button class="w-full mt-4 bg-x-blue hover:bg-x-blue-hover text-white px-4 py-2 rounded-lg transition-colors text-sm font-medium">
                                        Use Template
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- All Templates Section -->
                    <div>
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <svg class="w-5 h-5 text-x-blue mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 00-2 2v2m0 0V9a2 2 0 012-2h14a2 2 0 012 2v2M7 7V5a2 2 0 012-2h6a2 2 0 012 2v2"/>
                            </svg>
                            All Templates
                            <span class="ml-2 text-sm text-x-gray">(<span x-text="getFilteredTemplates().length"></span>)</span>
                        </h3>
                        
                        <!-- Templates Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <template x-for="template in getFilteredTemplates()" :key="template.id">
                                <div class="tweet-card rounded-2xl p-6 hover:border-x-gray/50 transition-all duration-200 cursor-pointer"
                                     @click="selectTemplate(template)">
                                    <!-- Template Header -->
                                    <div class="flex justify-between items-start mb-3">
                                        <div>
                                            <h4 class="text-white font-medium mb-1" x-text="template.name"></h4>
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs px-2 py-1 rounded-full bg-x-blue/20 text-x-blue" x-text="template.category"></span>
                                                <span x-show="template.isPro" class="text-xs px-2 py-1 rounded-full bg-amber-500/20 text-amber-400">Pro</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center text-x-gray text-sm">
                                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                            </svg>
                                            <span x-text="template.popularity + '%'"></span>
                                        </div>
                                    </div>
                                    
                                    <!-- Template Description -->
                                    <p class="text-x-gray text-sm mb-4" x-text="template.description"></p>
                                    
                                    <!-- Template Preview -->
                                    <div class="space-y-2">
                                        <template x-for="(tweet, index) in template.structure.slice(0, 2)" :key="index">
                                            <div class="text-xs text-x-gray bg-x-dark/50 rounded px-3 py-2 truncate" x-text="tweet.replace(/\{[^}]+\}/g, '...')"></div>
                                        </template>
                                        <div x-show="template.structure.length > 2" class="text-xs text-x-gray text-center">
                                            + <span x-text="template.structure.length - 2"></span> more tweets
                                        </div>
                                    </div>
                                    
                                    <!-- Use Template Button -->
                                    <button class="w-full mt-4 bg-x-blue hover:bg-x-blue-hover text-white px-4 py-2 rounded-lg transition-colors text-sm font-medium">
                                        Use Template
                                    </button>
                                </div>
                            </template>
                        </div>

                        <!-- Empty State -->
                        <div x-show="getFilteredTemplates().length === 0" class="tweet-card rounded-2xl p-12 text-center">
                            <div class="w-16 h-16 bg-x-dark rounded-full flex items-center justify-center mx-auto mb-6">
                                <svg class="w-8 h-8 text-x-gray" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-4">No templates found</h3>
                            <p class="text-x-gray mb-6">Try adjusting your search or filter criteria</p>
                            <button @click="templateSearch = ''; selectedCategory = 'all';" class="bg-x-blue hover:bg-x-blue-hover text-white px-6 py-2 rounded-lg transition-colors">
                                Clear Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Template Selection Modal -->
    <div 
        x-cloak
        x-show="showTemplateModal && selectedTemplate" 
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-end="opacity-0"
        @click.self="closeTemplateModal()"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50"
    >
        <div 
            x-show="showTemplateModal && selectedTemplate"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 transform scale-95"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-end="opacity-0 transform scale-95"
            @click.stop
            class="bg-x-black border border-x-border rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden"
        >
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-6 border-b border-x-border">
                <div>
                    <h3 class="text-xl font-bold text-white" x-text="selectedTemplate?.name"></h3>
                    <p class="text-x-gray text-sm mt-1" x-text="selectedTemplate?.description"></p>
                </div>
                <button @click="closeTemplateModal()" class="p-2 hover:bg-x-dark rounded-lg transition-colors">
                    <svg class="w-5 h-5 text-x-gray" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-180px)]">
                <!-- Pro Gate -->
                <div x-show="selectedTemplate?.isPro && (!user || !user.premium)" class="text-center py-8">
                    <div class="w-16 h-16 bg-amber-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                        </svg>
                    </div>
                    <h4 class="text-lg font-bold text-white mb-2">Pro Template</h4>
                    <p class="text-x-gray mb-6">This template is only available for Pro users. Upgrade to unlock premium templates and features.</p>
                    <div class="flex gap-3 justify-center">
                        <button @click="closeTemplateModal()" class="px-4 py-2 text-x-gray hover:text-white transition-colors">
                            Cancel
                        </button>
                        <button @click="openPaymentModal()" class="bg-amber-500 hover:bg-amber-600 text-black px-6 py-2 rounded-lg font-medium transition-colors">
                            Upgrade to Pro
                        </button>
                    </div>
                </div>

                <!-- Template Form -->
                <div x-show="!selectedTemplate?.isPro || (user && user.premium)">
                    <div class="mb-6">
                        <h4 class="text-sm font-medium text-white mb-4">Fill in the details below to customize your thread:</h4>
                        
                        <!-- Template Variables Form -->
                        <div class="space-y-4">
                            <template x-for="variable in selectedTemplate?.variables || []" :key="variable">
                                <div>
                                    <label class="block text-sm font-medium text-white mb-2" x-text="formatVariableLabel(variable)"></label>
                                    <textarea 
                                        x-model="templateFormData[variable]"
                                        :placeholder="getVariablePlaceholder(variable)"
                                        rows="2"
                                        class="w-full bg-x-dark border border-x-border rounded-lg px-3 py-2 text-white placeholder-x-gray focus:outline-none focus:border-x-blue resize-none"
                                    ></textarea>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Template Preview -->
                    <div class="mb-6">
                        <h4 class="text-sm font-medium text-white mb-4">Preview:</h4>
                        <div class="space-y-2 max-h-40 overflow-y-auto">
                            <template x-for="(tweet, index) in generatePreviewTweets()" :key="index">
                                <div class="bg-x-dark/50 rounded-lg p-3">
                                    <div class="text-xs text-x-gray mb-1">Tweet <span x-text="index + 1"></span></div>
                                    <div class="text-sm text-white" x-text="tweet"></div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-3 justify-end">
                        <button 
                            @click="closeTemplateModal()" 
                            class="px-4 py-2 text-x-gray hover:text-white transition-colors"
                        >
                            Cancel
                        </button>
                        <button 
                            @click="useTemplate()" 
                            :disabled="!isTemplateFormValid()"
                            :class="isTemplateFormValid() ? 'bg-x-blue hover:bg-x-blue-hover' : 'bg-x-gray cursor-not-allowed'"
                            class="px-6 py-2 text-white rounded-lg font-medium transition-colors"
                        >
                            Use Template
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function threadrApp() {
            return {
                inputType: 'url',
                urlInput: '',
                textInput: '',
                tweets: [],
                loading: false,
                error: '',
                copiedAll: false,
                viewMode: 'edit', // 'edit' or 'preview'
                showPaymentModal: false,
                
                paymentData: null,
                paymentConfig: null,
                
                // Authentication state
                user: null,
                authModalVisible: false,
                authMode: 'login', // 'login' or 'signup'
                authForm: {
                    email: '',
                    password: '',
                    confirmPassword: '',
                    rememberMe: false
                },
                authLoading: false,
                authError: '',
                
                sidebarOpen: false,
                
                // Page state
                currentPage: 'generate', // 'generate', 'templates', 'history', or 'analytics'
                
                // History state
                threadHistory: [],
                historyLoading: false,
                historyError: '',
                searchQuery: '',
                searchTimeout: null,
                selectedThread: null,
                showThreadModal: false,
                
                // Analytics state
                analyticsData: {
                    dashboard: null,
                    threads: [],
                    insights: null,
                    benchmarks: null
                },
                analyticsLoading: false,
                analyticsError: '',
                analyticsTimePeriod: '7d', // '1d', '7d', '30d'
                selectedAnalyticsThread: null,
                compareThreads: [], // Array for comparing thread analytics
                showComparisonModal: false,
                charts: {}, // Store Chart.js instances
                
                // Templates state
                templates: [
                    {
                        id: 'product-launch',
                        name: 'Product Launch Announcement',
                        description: 'Announce your new product with excitement and key features',
                        category: 'Business',
                        isPro: false,
                        popularity: 95,
                        variables: ['product_name', 'key_feature_1', 'key_feature_2', 'key_feature_3', 'launch_date', 'website_url'],
                        structure: [
                            "🚀 Big news! We're launching {product_name}!",
                            "After months of hard work, we're excited to share what we've built:",
                            "✨ {key_feature_1}",
                            "⚡ {key_feature_2}", 
                            "🔥 {key_feature_3}",
                            "Mark your calendars - {launch_date} is the day!",
                            "Ready to try it? Check it out: {website_url}",
                            "Retweet if you're as excited as we are! 🎉"
                        ]
                    },
                    {
                        id: 'tutorial-guide',
                        name: 'Tutorial/How-to Guide',
                        description: 'Step-by-step guide to teach your audience something valuable',
                        category: 'Educational',
                        isPro: false,
                        popularity: 88,
                        variables: ['topic', 'step_1', 'step_2', 'step_3', 'step_4', 'pro_tip', 'resource_link'],
                        structure: [
                            "🧵 How to {topic} (a step-by-step guide)",
                            "I've helped 100+ people master this. Here's exactly how to do it:",
                            "Step 1: {step_1}",
                            "Step 2: {step_2}",
                            "Step 3: {step_3}",
                            "Step 4: {step_4}",
                            "💡 Pro tip: {pro_tip}",
                            "Want more resources? Check out: {resource_link}",
                            "Found this helpful? Share it with others! ↗️"
                        ]
                    },
                    {
                        id: 'personal-story',
                        name: 'Personal Story/Journey',
                        description: 'Share your personal experience or transformation story',
                        category: 'Personal',
                        isPro: false,
                        popularity: 92,
                        variables: ['time_period', 'starting_point', 'challenge', 'turning_point', 'outcome', 'lesson_learned'],
                        structure: [
                            "{time_period} ago, I was {starting_point}",
                            "I was struggling with {challenge} and felt stuck.",
                            "Then something changed: {turning_point}",
                            "Fast forward to today: {outcome}",
                            "The biggest lesson I learned: {lesson_learned}",
                            "Your current situation is not your final destination.",
                            "What's one small step you can take today? 💪"
                        ]
                    },
                    {
                        id: 'news-breakdown',
                        name: 'Industry News Breakdown',
                        description: 'Analyze and explain breaking news or industry updates',
                        category: 'Business',
                        isPro: true,
                        popularity: 76,
                        variables: ['news_topic', 'key_fact_1', 'key_fact_2', 'impact', 'prediction', 'action_item'],
                        structure: [
                            "🔥 Breaking: {news_topic}",
                            "Here's what you need to know (and why it matters):",
                            "Key facts:",
                            "• {key_fact_1}",
                            "• {key_fact_2}",
                            "Why this matters: {impact}",
                            "My prediction: {prediction}",
                            "What should you do? {action_item}",
                            "What are your thoughts on this? 👇"
                        ]
                    },
                    {
                        id: 'tips-tricks',
                        name: 'Tips and Tricks List',
                        description: 'Share actionable tips and tricks about your expertise',
                        category: 'Educational',
                        isPro: false,
                        popularity: 90,
                        variables: ['topic', 'tip_1', 'tip_2', 'tip_3', 'tip_4', 'tip_5', 'bonus_tip'],
                        structure: [
                            "5 {topic} tips that changed my game:",
                            "1. {tip_1}",
                            "2. {tip_2}",
                            "3. {tip_3}",
                            "4. {tip_4}",
                            "5. {tip_5}",
                            "Bonus tip: {bonus_tip}",
                            "Which tip resonates most with you? Let me know! 👇"
                        ]
                    },
                    {
                        id: 'case-study',
                        name: 'Case Study Analysis',
                        description: 'Deep dive into a successful project or campaign',
                        category: 'Business',
                        isPro: true,
                        popularity: 71,
                        variables: ['company_name', 'challenge', 'strategy', 'execution', 'results', 'takeaway'],
                        structure: [
                            "Case Study: How {company_name} solved {challenge}",
                            "The Problem: {challenge} was costing them thousands monthly.",
                            "The Strategy: {strategy}",
                            "The Execution: {execution}",
                            "The Results: {results}",
                            "Key Takeaway: {takeaway}",
                            "Apply this to your business and watch what happens 📈"
                        ]
                    },
                    {
                        id: 'book-summary',
                        name: 'Book/Article Summary',
                        description: 'Summarize key insights from books or articles',
                        category: 'Educational',
                        isPro: false,
                        popularity: 84,
                        variables: ['title', 'author', 'main_insight', 'insight_1', 'insight_2', 'insight_3', 'actionable_takeaway'],
                        structure: [
                            "Just finished \"{title}\" by {author}",
                            "The main insight that blew my mind: {main_insight}",
                            "3 key takeaways:",
                            "📖 {insight_1}",
                            "💡 {insight_2}",
                            "🔥 {insight_3}",
                            "Most actionable takeaway: {actionable_takeaway}",
                            "10/10 recommend if you want to level up! 📚"
                        ]
                    },
                    {
                        id: 'controversial-opinion',
                        name: 'Controversial Opinion/Hot Take',
                        description: 'Share a bold opinion that sparks discussion',
                        category: 'Personal',
                        isPro: true,
                        popularity: 68,
                        variables: ['opinion', 'reason_1', 'reason_2', 'counterargument', 'final_thought'],
                        structure: [
                            "Unpopular opinion: {opinion}",
                            "Here's why I believe this:",
                            "Reason 1: {reason_1}",
                            "Reason 2: {reason_2}",
                            "I know some will say: {counterargument}",
                            "But here's the thing: {final_thought}",
                            "Change my mind (or agree) in the comments 👇",
                            "RT if you think I'm onto something 🔥"
                        ]
                    },
                    {
                        id: 'behind-scenes',
                        name: 'Behind the Scenes',
                        description: 'Give followers a peek behind the curtain',
                        category: 'Personal', 
                        isPro: false,
                        popularity: 82,
                        variables: ['project', 'challenge', 'solution', 'unexpected_learning', 'current_status'],
                        structure: [
                            "Behind the scenes of {project}:",
                            "What you see: The polished final result",
                            "What you don't see: {challenge}",
                            "How we solved it: {solution}",
                            "Plot twist: {unexpected_learning}",
                            "Current status: {current_status}",
                            "The messy middle is where the magic happens ✨"
                        ]
                    },
                    {
                        id: 'resource-compilation',
                        name: 'Resource Compilation',
                        description: 'Curated list of valuable resources and tools',
                        category: 'Educational',
                        isPro: true,
                        popularity: 79,
                        variables: ['topic', 'resource_1', 'resource_2', 'resource_3', 'resource_4', 'bonus_resource'],
                        structure: [
                            "Ultimate {topic} resource list (bookmark this 🔖)",
                            "After 5+ years, these are my go-to resources:",
                            "🔗 {resource_1}",
                            "⚡ {resource_2}",
                            "💎 {resource_3}",
                            "🚀 {resource_4}",
                            "Bonus: {bonus_resource} (my secret weapon)",
                            "Save this tweet - you'll thank me later!",
                            "What would you add to this list? 👇"
                        ]
                    },
                    {
                        id: 'qa-format',
                        name: 'Q&A Format',
                        description: 'Answer common questions in your field',
                        category: 'Educational',
                        isPro: false,
                        popularity: 75,
                        variables: ['topic', 'question_1', 'answer_1', 'question_2', 'answer_2', 'question_3', 'answer_3'],
                        structure: [
                            "Common {topic} questions (answered):",
                            "Q: {question_1}",
                            "A: {answer_1}",
                            "Q: {question_2}",
                            "A: {answer_2}",
                            "Q: {question_3}",
                            "A: {answer_3}",
                            "Got more questions? Drop them below! 👇"
                        ]
                    },
                    {
                        id: 'problem-solution',
                        name: 'Problem/Solution',
                        description: 'Present a common problem and your solution',
                        category: 'Business',
                        isPro: false,
                        popularity: 86,
                        variables: ['problem', 'why_common', 'solution', 'benefit_1', 'benefit_2', 'how_to_start'],
                        structure: [
                            "Problem: {problem}",
                            "This affects 80% of people because {why_common}",
                            "The solution: {solution}",
                            "Benefits:",
                            "✅ {benefit_1}",
                            "✅ {benefit_2}",
                            "How to start: {how_to_start}",
                            "Don't let this problem hold you back any longer 💪"
                        ]
                    },
                    {
                        id: 'transformation',
                        name: 'Before/After Transformation',
                        description: 'Showcase a dramatic before and after transformation',
                        category: 'Personal',
                        isPro: true,
                        popularity: 89,
                        variables: ['timeframe', 'before_state', 'catalyst', 'changes_made', 'after_state', 'key_lesson'],
                        structure: [
                            "{timeframe} transformation thread 🧵",
                            "BEFORE: {before_state}",
                            "The catalyst: {catalyst}",
                            "What changed: {changes_made}",
                            "AFTER: {after_state}",
                            "Key lesson: {key_lesson}",
                            "Your future self is counting on the decisions you make today.",
                            "What transformation are you working on? 👇"
                        ]
                    },
                    {
                        id: 'myth-busting',
                        name: 'Myth Busting',
                        description: 'Debunk common myths in your industry',  
                        category: 'Educational',
                        isPro: true,
                        popularity: 73,
                        variables: ['topic', 'myth_1', 'reality_1', 'myth_2', 'reality_2', 'why_myths_persist'],
                        structure: [
                            "🚫 {topic} myths that need to die:",
                            "Myth #1: {myth_1}",
                            "Reality: {reality_1}",
                            "Myth #2: {myth_2}",
                            "Reality: {reality_2}",
                            "Why these myths persist: {why_myths_persist}",
                            "Stop believing the hype. Focus on what actually works.",
                            "What myths would you add to this list? 👇"
                        ]
                    },
                    {
                        id: 'future-predictions',
                        name: 'Future Predictions',
                        description: 'Share your predictions about industry trends',
                        category: 'Business',
                        isPro: true,
                        popularity: 67,
                        variables: ['industry', 'prediction_1', 'evidence_1', 'prediction_2', 'evidence_2', 'timeline', 'preparation_tip'],
                        structure: [
                            "My {industry} predictions for the next 2 years:",
                            "Prediction 1: {prediction_1}",
                            "Evidence: {evidence_1}",
                            "Prediction 2: {prediction_2}",
                            "Evidence: {evidence_2}",
                            "Timeline: {timeline}",
                            "How to prepare: {preparation_tip}",
                            "RemindMe! 2 years to see how accurate these were 📅"
                        ]
                    }
                ],
                selectedTemplate: null,
                templateSearch: '',
                selectedCategory: 'all',
                showTemplateModal: false,
                showUpgradeModal: false,
                templateFormData: {},
                
                // Initialize authentication on component load
                init() {
                    // Set initialization flag to prevent modals during startup
                    this._isInitializing = true;
                    
                    // CRITICAL FIX: Force all modals closed and template cleared FIRST
                    this.showTemplateModal = false;
                    this.selectedTemplate = null;
                    this.showPaymentModal = false;
                    this.showUpgradeModal = false;
                    this.showComparisonModal = false;
                    this.showThreadModal = false;
                    this.authModalVisible = false;
                    this.templateFormData = {};
                    this.currentPage = 'generate';
                    
                    // Load user data AFTER clearing state (will skip token verification during init)
                    this.loadUserFromStorage();
                    
                    // Additional safety check after a brief delay to handle any race conditions
                    setTimeout(() => {
                        this.showTemplateModal = false;
                        this.selectedTemplate = null;
                        this.showPaymentModal = false;
                        this.authModalVisible = false;
                        // Clear initialization flag after startup is complete
                        this._isInitializing = false;
                    }, 100);
                    
                    // Emergency close function for debugging - attach to window
                    window.emergencyCloseModal = () => {
                        console.log('Emergency close triggered');
                        this.showPaymentModal = false;
                        this.showTemplateModal = false;
                        this.authModalVisible = false;
                        this.showThreadModal = false;
                    };
                    
                    // Log successful initialization
                    console.log('Threadr app initialized successfully');
                    console.log('Emergency close available: window.emergencyCloseModal()');
                },
                
                // Check if user is authenticated
                isAuthenticated() {
                    return !!this.user && !!this.getAuthToken();
                },
                
                // Get stored JWT token
                getAuthToken() {
                    return localStorage.getItem('threadr_token');
                },
                
                // Get stored refresh token
                getRefreshToken() {
                    return localStorage.getItem('threadr_refresh_token');
                },
                
                // Load user data from localStorage
                loadUserFromStorage() {
                    const token = this.getAuthToken();
                    const userData = localStorage.getItem('threadr_user');
                    
                    if (token && userData) {
                        try {
                            this.user = JSON.parse(userData);
                            // Only verify token if not during initialization to prevent modals
                            if (this._isInitializing !== true) {
                                this.verifyToken();
                            }
                        } catch (error) {
                            console.error('Failed to parse user data:', error);
                            this.clearAuthData();
                        }
                    }
                },
                
                // Verify JWT token with backend
                async verifyToken() {
                    const token = this.getAuthToken();
                    if (!token) return;
                    
                    try {
                        const response = await fetch(`${config.API_URL}/api/auth/me`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Accept': 'application/json'
                            }
                        });
                        
                        if (!response.ok) {
                            // Token is invalid, clear auth data silently
                            this.clearAuthData();
                        } else {
                            const userData = await response.json();
                            this.user = userData;
                            localStorage.setItem('threadr_user', JSON.stringify(userData));
                        }
                    } catch (error) {
                        console.error('Token verification failed:', error);
                        // During initialization, fail silently - no refresh attempts or modals
                        if (this._isInitializing === true) {
                            this.clearAuthData();
                            return;
                        }
                        
                        // If token verification fails, try to refresh token (only when not initializing)
                        if (this.getRefreshToken()) {
                            try {
                                console.log('Attempting token refresh...');
                                await this.refreshAccessToken();
                                console.log('Token refreshed successfully');
                            } catch (refreshError) {
                                console.error('Token refresh failed, clearing auth data:', refreshError);
                                this.clearAuthData();
                            }
                        } else {
                            // No refresh token available, clear auth data
                            this.clearAuthData();
                        }
                    }
                },
                
                // Clear authentication data
                clearAuthData() {
                    this.user = null;
                    localStorage.removeItem('threadr_token');
                    localStorage.removeItem('threadr_refresh_token');
                    localStorage.removeItem('threadr_user');
                },
                
                // Show authentication modal
                showAuthModal(mode = 'login') {
                    this.authMode = mode;
                    this.authForm.email = '';
                    this.authForm.password = '';
                    this.authForm.confirmPassword = '';
                    this.authForm.rememberMe = false;
                    this.authError = '';
                    this.authModalVisible = true;
                },
                
                // Close authentication modal
                closeAuthModal() {
                    this.authModalVisible = false;
                    this.authError = '';
                    this.authLoading = false;
                },
                
                // Toggle between login and signup
                toggleAuthMode() {
                    this.authMode = this.authMode === 'login' ? 'signup' : 'login';
                    this.authError = '';
                },
                
                // Handle authentication (login/signup)
                async handleAuth() {
                    if (!this.authForm.email || !this.authForm.password) {
                        this.authError = 'Please fill in all fields';
                        return;
                    }
                    
                    // Additional validation for signup
                    if (this.authMode === 'signup') {
                        if (!this.authForm.confirmPassword) {
                            this.authError = 'Please confirm your password';
                            return;
                        }
                        if (this.authForm.password !== this.authForm.confirmPassword) {
                            this.authError = 'Passwords do not match';
                            return;
                        }
                    }
                    
                    this.authLoading = true;
                    this.authError = '';
                    
                    try {
                        const endpoint = this.authMode === 'login' ? '/api/auth/login' : '/api/auth/register';
                        const response = await fetch(`${config.API_URL}${endpoint}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify(
                                this.authMode === 'signup' 
                                    ? {
                                        email: this.authForm.email,
                                        password: this.authForm.password,
                                        confirm_password: this.authForm.confirmPassword
                                    }
                                    : {
                                        email: this.authForm.email,
                                        password: this.authForm.password,
                                        remember_me: this.authForm.rememberMe
                                    }
                            )
                        });
                        
                        const data = await response.json();
                        
                        if (!response.ok) {
                            // Handle different error response formats
                            let errorMessage = 'Authentication failed';
                            
                            if (response.status === 422 && data.detail) {
                                // Handle both old and new validation error formats
                                if (Array.isArray(data.detail)) {
                                    // Old FastAPI validation errors format
                                    const validationErrors = data.detail.map(error => {
                                        const field = error.loc ? error.loc[error.loc.length - 1] : 'field';
                                        return `${field}: ${error.msg}`;
                                    }).join(', ');
                                    errorMessage = validationErrors;
                                } else if (typeof data.detail === 'string') {
                                    // New simplified format from our custom handler
                                    errorMessage = data.detail;
                                }
                            } else if (data.detail && typeof data.detail === 'string') {
                                errorMessage = data.detail;
                            } else if (data.message && typeof data.message === 'string') {
                                errorMessage = data.message;
                            } else if (typeof data === 'string') {
                                errorMessage = data;
                            }
                            
                            throw new Error(errorMessage);
                        }
                        
                        // Store token and user data
                        localStorage.setItem('threadr_token', data.access_token);
                        if (data.refresh_token) {
                            localStorage.setItem('threadr_refresh_token', data.refresh_token);
                        }
                        localStorage.setItem('threadr_user', JSON.stringify(data.user));
                        this.user = data.user;
                        
                        // Close modal
                        this.closeAuthModal();
                        
                    } catch (error) {
                        console.error('Authentication error:', error);
                        this.authError = error.message || 'Authentication failed. Please try again.';
                    } finally {
                        this.authLoading = false;
                    }
                },
                
                // Logout user
                async logout() {
                    const token = this.getAuthToken();
                    
                    // Call backend logout endpoint
                    if (token) {
                        try {
                            await fetch(`${config.API_URL}/api/auth/logout`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Accept': 'application/json'
                                }
                            });
                        } catch (error) {
                            console.error('Logout error:', error);
                            // Continue with local logout even if backend call fails
                        }
                    }
                    
                    // Clear local auth data
                    this.clearAuthData();
                },
                
                // Refresh access token using refresh token
                async refreshAccessToken() {
                    const refreshToken = this.getRefreshToken();
                    if (!refreshToken) {
                        throw new Error('No refresh token available');
                    }
                    
                    try {
                        const response = await fetch(`${config.API_URL}/api/auth/refresh`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify({
                                refresh_token: refreshToken
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error('Token refresh failed');
                        }
                        
                        const data = await response.json();
                        
                        // Update stored tokens and user data
                        localStorage.setItem('threadr_token', data.access_token);
                        if (data.refresh_token) {
                            localStorage.setItem('threadr_refresh_token', data.refresh_token);
                        }
                        localStorage.setItem('threadr_user', JSON.stringify(data.user));
                        this.user = data.user;
                        
                        return data.access_token;
                        
                    } catch (error) {
                        console.error('Token refresh failed:', error);
                        // Clear auth data if refresh fails
                        this.clearAuthData();
                        throw error;
                    }
                },

                getHeaders() {
                    const headers = {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    };
                    
                    // Add JWT Bearer token if user is authenticated
                    const token = this.getAuthToken();
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    
                    // Add API key header for non-development environments (ALWAYS needed for /api/generate)
                    const hostname = window.location.hostname;
                    const isDevelopment = hostname === 'localhost' || hostname === '127.0.0.1' || hostname.startsWith('192.168.');
                    
                    if (!isDevelopment) {
                        headers['X-API-Key'] = config.API_KEY || 'zfQBge1AsBBLF8nMNxiHdyFn-_fS7vsTtcTrveXnyD8';
                    }
                    
                    return headers;
                },

                async generateThread() {
                    console.log('Generate thread called');
                    
                    // Basic input validation
                    if (this.inputType === 'url' && !this.urlInput) {
                        this.error = 'Please enter a URL';
                        return;
                    }
                    
                    if (this.inputType === 'text' && !this.textInput) {
                        this.error = 'Please enter some text';
                        return;
                    }

                    this.loading = true;
                    this.error = '';
                    this.tweets = [];

                    try {
                        const headers = this.getHeaders();

                        const response = await fetch(`${config.API_URL}/api/generate`, {
                            method: 'POST',
                            headers: headers,
                            mode: 'cors',
                            credentials: 'omit',
                            body: JSON.stringify(
                                this.inputType === 'url' 
                                    ? { url: this.urlInput }
                                    : { text: this.textInput }
                            )
                        });

                        if (!response.ok) {
                            let errorMessage = 'Failed to generate thread. Please try again.';
                            
                            try {
                                const errorData = await response.json();
                                
                                // Handle 401 Unauthorized - try refresh token first
                                if (response.status === 401) {
                                    if (this.getRefreshToken()) {
                                        try {
                                            console.log('401 error, attempting token refresh...');
                                            await this.refreshAccessToken();
                                            // Retry the original request with new token
                                            console.log('Token refreshed, retrying request...');
                                            return await this.generateThread();
                                        } catch (refreshError) {
                                            console.error('Token refresh failed:', refreshError);
                                            this.clearAuthData();
                                            // Only show auth modal if not during initialization
                                            if (this._isInitializing !== true) {
                                                this.showAuthModal('login');
                                                this.authError = 'Session expired. Please log in again.';
                                            }
                                            return;
                                        }
                                    } else {
                                        this.clearAuthData();
                                        // Only show auth modal if not during initialization
                                        if (this._isInitializing !== true) {
                                            this.showAuthModal('login');
                                            this.authError = 'Please log in to continue';
                                        }
                                        return;
                                    }
                                }
                                
                                // Handle 402 Payment Required specifically (but not during initialization)
                                if (response.status === 402 && this._isInitializing !== true) {
                                    this.showPaymentRequired(errorData);
                                    return;
                                }
                                
                                errorMessage = errorData.detail || errorData.message || errorMessage;
                            } catch (parseError) {
                                if (response.status === 401) {
                                    this.clearAuthData();
                                    // Only show auth modal if not during initialization
                                    if (this._isInitializing !== true) {
                                        this.showAuthModal('login');
                                        this.authError = 'Please log in to continue';
                                    }
                                    return;
                                } else if (response.status === 429) {
                                    errorMessage = 'Rate limit exceeded. Please try again later.';
                                } else if (response.status === 402) {
                                    errorMessage = "You've reached your daily limit of 5 free threads. Upgrade to premium for unlimited access!";
                                } else if (response.status >= 500) {
                                    errorMessage = 'Server error. Please try again in a moment.';
                                }
                            }
                            
                            throw new Error(errorMessage);
                        }

                        const data = await response.json();
                        
                        if (!data || !data.thread || !Array.isArray(data.thread)) {
                            throw new Error('Invalid response format from server.');
                        }

                        this.tweets = data.thread.map(tweet => ({
                            text: tweet.content || tweet.text || '',
                            copied: false
                        }));

                        if (this.tweets.length === 0) {
                            throw new Error('No tweets were generated. Please try with different content.');
                        }

                        // Save thread to history if user is authenticated
                        if (this.isAuthenticated() && data.thread_id) {
                            // Thread should be automatically saved by backend
                            // Optionally refresh history if we're on history page
                            if (this.currentPage === 'history') {
                                this.loadThreadHistory();
                            }
                        }

                    } catch (error) {
                        console.error('Thread generation error:', error);
                        this.error = error.message || 'An unexpected error occurred. Please try again.';

                        // Fallback to demo tweets in development
                        if (window.location.hostname === 'localhost') {
                            console.log('Falling back to demo tweets');
                            this.generateMockTweets();
                            this.error = 'Demo mode: ' + this.error;
                        }
                    } finally {
                        this.loading = false;
                    }
                },

                generateMockTweets() {
                    this.tweets = [
                        {
                            text: "🧵 Here's an interesting article I found that's worth sharing. Let me break it down for you in this thread.",
                            copied: false
                        },
                        {
                            text: "The main point revolves around innovation and how it's changing our daily lives. The insights are quite compelling.",
                            copied: false
                        },
                        {
                            text: "What struck me most was the emphasis on adaptability. In today's fast-paced world, being able to pivot quickly is crucial.",
                            copied: false
                        },
                        {
                            text: "Key takeaway: Success isn't just about having great ideas, it's about execution and timing. Both matter equally.",
                            copied: false
                        }
                    ];
                },

                async showPaymentRequired(errorData) {
                    this.paymentData = errorData;
                    
                    // Fetch payment configuration from backend
                    try {
                        const response = await fetch(`${config.API_URL}/api/payment/config`, {
                            method: 'GET',
                            headers: this.getHeaders(),
                            mode: 'cors',
                            credentials: 'omit'
                        });
                        
                        if (response.ok) {
                            this.paymentConfig = await response.json();
                        } else {
                            // If payment config fails, provide fallback
                            this.paymentConfig = {
                                payment_url: 'https://buy.stripe.com/test_placeholder',
                                price: '$4.99'
                            };
                        }
                    } catch (error) {
                        console.error('Failed to fetch payment config:', error);
                        // Provide fallback payment config to prevent modal from being broken
                        this.paymentConfig = {
                            payment_url: 'https://buy.stripe.com/test_placeholder',
                            price: '$4.99'
                        };
                    }
                    
                    this.showPaymentModal = true;
                    this.loading = false;
                    
                    // Also set a user-friendly error message as fallback
                    this.error = `You've reached your daily limit of ${errorData.limit || 5} free threads. Upgrade to premium for unlimited access!`;
                },

                async upgradeNow() {
                    // Use payment URL from config, fallback to paymentData
                    const paymentUrl = this.paymentConfig?.payment_url || this.paymentData?.upgrade_url;
                    
                    if (paymentUrl && paymentUrl !== '#') {
                        window.open(paymentUrl, '_blank');
                        this.closePaymentModal();
                    } else {
                        console.error('No payment URL available');
                        // Don't set error here - the button should be disabled instead
                        // this.error = 'Payment system not configured. Please try again later.';
                    }
                },

                closePaymentModal() {
                    console.log('Closing payment modal');
                    this.showPaymentModal = false;
                    this.paymentData = null;
                    this.paymentConfig = null;
                    
                    // Force Alpine.js to re-evaluate the modal state
                    this.$nextTick(() => {
                        console.log('Payment modal state after close:', this.showPaymentModal);
                    });
                },

                async openPaymentModal() {
                    console.log('Opening payment modal');
                    // Close template modal first
                    this.closeTemplateModal();
                    
                    // Open payment modal with default configuration
                    await this.showPaymentRequired({
                        limit: 5,
                        period: 'daily',
                        upgrade_url: '#'
                    });
                },

                updateTweet(index, event) {
                    this.tweets[index].text = event.target.innerText;
                },

                validateTweetLength(index) {
                    if (this.tweets[index].text.length > 280) {
                        this.error = `Tweet ${index + 1} exceeds 280 characters. Please shorten it.`;
                    } else {
                        this.error = '';
                    }
                },

                async copyTweet(index) {
                    try {
                        await navigator.clipboard.writeText(this.tweets[index].text);
                        this.tweets[index].copied = true;
                        setTimeout(() => {
                            this.tweets[index].copied = false;
                        }, 2000);
                    } catch (err) {
                        this.error = 'Failed to copy tweet';
                    }
                },

                async copyAllTweets() {
                    try {
                        const allTweets = this.tweets.map((tweet, index) => 
                            `${index + 1}/${this.tweets.length}\n${tweet.text}`
                        ).join('\n\n');
                        
                        await navigator.clipboard.writeText(allTweets);
                        this.copiedAll = true;
                        setTimeout(() => {
                            this.copiedAll = false;
                        }, 2000);
                    } catch (err) {
                        this.error = 'Failed to copy thread';
                    }
                },

                // Page navigation
                switchToPage(page) {
                    this.currentPage = page;
                    this.sidebarOpen = false; // Close mobile sidebar
                    
                    if (page === 'history') {
                        this.loadThreadHistory();
                    } else if (page === 'analytics') {
                        this.loadAnalytics();
                    } else if (page === 'templates') {
                        // Force Alpine.js to re-evaluate template functions for reactivity
                        this.$nextTick(() => {
                            // Trigger template data refresh by accessing the functions
                            this.getPopularTemplates();
                            this.getFilteredTemplates();
                        });
                    }
                },

                // History functions
                async loadThreadHistory() {
                    if (!this.isAuthenticated()) {
                        this.historyError = 'Please log in to view your thread history';
                        return;
                    }

                    this.historyLoading = true;
                    this.historyError = '';

                    try {
                        const response = await fetch(`${config.API_URL}/api/threads`, {
                            method: 'GET',
                            headers: this.getHeaders(),
                            mode: 'cors',
                            credentials: 'omit'
                        });

                        if (!response.ok) {
                            if (response.status === 401) {
                                // Try to refresh token
                                if (this.getRefreshToken()) {
                                    try {
                                        await this.refreshAccessToken();
                                        return await this.loadThreadHistory(); // Retry
                                    } catch (refreshError) {
                                        this.clearAuthData();
                                        this.historyError = 'Session expired. Please log in again.';
                                        return;
                                    }
                                } else {
                                    this.clearAuthData();
                                    this.historyError = 'Please log in to view your history';
                                    return;
                                }
                            }
                            throw new Error('Failed to load thread history');
                        }

                        const data = await response.json();
                        this.threadHistory = data.threads || [];
                    } catch (error) {
                        console.error('Failed to load thread history:', error);
                        this.historyError = error.message || 'Failed to load thread history';
                    } finally {
                        this.historyLoading = false;
                    }
                },

                filteredThreads() {
                    if (!this.searchQuery) {
                        return this.threadHistory;
                    }
                    
                    const query = this.searchQuery.toLowerCase();
                    return this.threadHistory.filter(thread => 
                        (thread.title && thread.title.toLowerCase().includes(query)) ||
                        (thread.preview && thread.preview.toLowerCase().includes(query)) ||
                        (thread.source_url && thread.source_url.toLowerCase().includes(query))
                    );
                },

                debounceSearch() {
                    if (this.searchTimeout) {
                        clearTimeout(this.searchTimeout);
                    }
                    this.searchTimeout = setTimeout(() => {
                        // Search is handled by filteredThreads() reactively
                    }, 300);
                },

                formatDate(dateString) {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    const now = new Date();
                    const diffTime = Math.abs(now - date);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 1) return 'Today';
                    if (diffDays === 2) return 'Yesterday';
                    if (diffDays <= 7) return `${diffDays - 1} days ago`;
                    
                    return date.toLocaleDateString();
                },

                async viewThread(thread) {
                    try {
                        // Fetch full thread details if not already loaded
                        if (!thread.tweets) {
                            const response = await fetch(`${config.API_URL}/api/threads/${thread.id}`, {
                                method: 'GET',
                                headers: this.getHeaders(),
                                mode: 'cors',
                                credentials: 'omit'
                            });

                            if (response.ok) {
                                const fullThread = await response.json();
                                thread.tweets = fullThread.tweets;
                            }
                        }
                        
                        this.selectedThread = thread;
                        this.showThreadModal = true;
                    } catch (error) {
                        console.error('Failed to load thread details:', error);
                        this.historyError = 'Failed to load thread details';
                    }
                },

                closeThreadModal() {
                    this.showThreadModal = false;
                    this.selectedThread = null;
                },

                async copyThread(thread) {
                    if (!thread) return;
                    
                    try {
                        let tweetsText = '';
                        
                        if (thread.tweets && Array.isArray(thread.tweets)) {
                            tweetsText = thread.tweets.map((tweet, index) => 
                                `${index + 1}/${thread.tweets.length}\n${tweet.content || tweet.text}`
                            ).join('\n\n');
                        } else if (thread.preview) {
                            tweetsText = thread.preview;
                        } else {
                            tweetsText = thread.title || 'Thread content not available';
                        }
                        
                        await navigator.clipboard.writeText(tweetsText);
                        
                        // Track copy action with backend if thread has ID
                        if (thread.id) {
                            try {
                                await fetch(`${config.API_URL}/api/threads/${thread.id}/copy`, {
                                    method: 'POST',
                                    headers: this.getHeaders(),
                                    mode: 'cors',
                                    credentials: 'omit'
                                });
                            } catch (trackError) {
                                // Don't fail the copy operation if tracking fails
                                console.error('Failed to track copy action:', trackError);
                            }
                        }
                        
                        // Show success feedback
                        thread.copied = true;
                        setTimeout(() => {
                            thread.copied = false;
                        }, 2000);
                        
                    } catch (err) {
                        console.error('Failed to copy thread:', err);
                        this.historyError = 'Failed to copy thread';
                    }
                },

                async copyTweetFromModal(tweet, index) {
                    try {
                        await navigator.clipboard.writeText(tweet.content || tweet.text);
                        tweet.copied = true;
                        setTimeout(() => {
                            tweet.copied = false;
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy tweet:', err);
                    }
                },

                async toggleFavorite(thread) {
                    if (!thread.id) return;
                    
                    try {
                        const response = await fetch(`${config.API_URL}/api/threads/${thread.id}`, {
                            method: 'PATCH',
                            headers: this.getHeaders(),
                            mode: 'cors',
                            credentials: 'omit',
                            body: JSON.stringify({
                                is_favorite: !thread.is_favorite
                            })
                        });

                        if (response.ok) {
                            thread.is_favorite = !thread.is_favorite;
                        } else {
                            throw new Error('Failed to update favorite status');
                        }
                    } catch (error) {
                        console.error('Failed to toggle favorite:', error);
                        this.historyError = 'Failed to update favorite status';
                    }
                },

                async deleteThread(thread) {
                    if (!thread.id) return;
                    
                    if (!confirm('Are you sure you want to delete this thread? This action cannot be undone.')) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`${config.API_URL}/api/threads/${thread.id}`, {
                            method: 'DELETE',
                            headers: this.getHeaders(),
                            mode: 'cors',
                            credentials: 'omit'
                        });

                        if (response.ok) {
                            // Remove from local array
                            this.threadHistory = this.threadHistory.filter(t => t.id !== thread.id);
                            
                            // Close modal if this thread was being viewed
                            if (this.selectedThread && this.selectedThread.id === thread.id) {
                                this.closeThreadModal();
                            }
                        } else {
                            throw new Error('Failed to delete thread');
                        }
                    } catch (error) {
                        console.error('Failed to delete thread:', error);
                        this.historyError = 'Failed to delete thread';
                    }
                },

                // Analytics functions
                async loadAnalytics() {
                    if (!this.isAuthenticated()) {
                        this.analyticsError = 'Please log in to view analytics';
                        return;
                    }
                    
                    if (!this.user?.premium) {
                        this.analyticsError = 'Analytics is a premium feature. Upgrade to Pro to access detailed analytics.';
                        return;
                    }
                    
                    this.analyticsLoading = true;
                    this.analyticsError = '';
                    
                    try {
                        // Load dashboard data
                        await this.loadDashboardData();
                        await this.loadThreadAnalytics();
                        await this.loadInsights();
                        await this.loadBenchmarks();
                        
                        // Initialize charts after data is loaded
                        setTimeout(() => this.initializeCharts(), 100);
                    } catch (error) {
                        console.error('Failed to load analytics:', error);
                        this.analyticsError = 'Failed to load analytics data';
                    } finally {
                        this.analyticsLoading = false;
                    }
                },

                async loadDashboardData() {
                    const response = await fetch(`${config.API_URL}/api/analytics/dashboard?period=${this.analyticsTimePeriod}`, {
                        method: 'GET',
                        headers: this.getHeaders(),
                        mode: 'cors',
                        credentials: 'omit'
                    });
                    
                    if (!response.ok) throw new Error('Failed to load dashboard data');
                    this.analyticsData.dashboard = await response.json();
                },

                async loadThreadAnalytics() {
                    const response = await fetch(`${config.API_URL}/api/analytics/threads?period=${this.analyticsTimePeriod}`, {
                        method: 'GET',
                        headers: this.getHeaders(),
                        mode: 'cors',
                        credentials: 'omit'
                    });
                    
                    if (!response.ok) throw new Error('Failed to load thread analytics');
                    this.analyticsData.threads = await response.json();
                },

                async loadInsights() {
                    const response = await fetch(`${config.API_URL}/api/analytics/insights?period=${this.analyticsTimePeriod}`, {
                        method: 'GET',
                        headers: this.getHeaders(),
                        mode: 'cors',
                        credentials: 'omit'
                    });
                    
                    if (!response.ok) throw new Error('Failed to load insights');
                    this.analyticsData.insights = await response.json();
                },

                async loadBenchmarks() {
                    const response = await fetch(`${config.API_URL}/api/analytics/benchmarks`, {
                        method: 'GET',
                        headers: this.getHeaders(),
                        mode: 'cors',
                        credentials: 'omit'  
                    });
                    
                    if (!response.ok) throw new Error('Failed to load benchmarks');
                    this.analyticsData.benchmarks = await response.json();
                },

                changeTimePeriod(period) {
                    this.analyticsTimePeriod = period;
                    this.loadAnalytics();
                },

                initializeCharts() {
                    // Destroy existing charts
                    Object.values(this.charts).forEach(chart => {
                        if (chart) chart.destroy();
                    });
                    this.charts = {};

                    if (!this.analyticsData.dashboard) return;

                    // Engagement over time chart
                    const engagementCtx = document.getElementById('engagementChart');
                    if (engagementCtx && this.analyticsData.dashboard.engagement_over_time) {
                        this.charts.engagement = new Chart(engagementCtx, {
                            type: 'line',
                            data: {
                                labels: this.analyticsData.dashboard.engagement_over_time.map(d => d.date),
                                datasets: [{
                                    label: 'Engagement Rate',
                                    data: this.analyticsData.dashboard.engagement_over_time.map(d => d.engagement_rate),
                                    borderColor: '#1d9bf0',
                                    backgroundColor: 'rgba(29, 155, 240, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: { color: '#8899ac' },
                                        grid: { color: '#38444d' }
                                    },
                                    x: {
                                        ticks: { color: '#8899ac' },
                                        grid: { color: '#38444d' }
                                    }
                                }
                            }
                        });
                    }

                    // Thread performance chart
                    const performanceCtx = document.getElementById('performanceChart');
                    if (performanceCtx && this.analyticsData.threads.length > 0) {
                        const topThreads = this.analyticsData.threads.slice(0, 10);
                        this.charts.performance = new Chart(performanceCtx, {
                            type: 'bar',
                            data: {
                                labels: topThreads.map(t => t.title?.slice(0, 20) + '...' || 'Untitled'),
                                datasets: [{
                                    label: 'Total Engagement',
                                    data: topThreads.map(t => t.total_engagement),
                                    backgroundColor: '#1d9bf0',
                                    borderRadius: 4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: { color: '#8899ac' },
                                        grid: { color: '#38444d' }
                                    },
                                    x: {
                                        ticks: { color: '#8899ac', maxRotation: 45 },
                                        grid: { color: '#38444d' }
                                    }
                                }
                            }
                        });
                    }
                },

                formatNumber(num) {
                    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                    return num?.toString() || '0';
                },

                formatPercentage(num) {
                    return (num || 0).toFixed(1) + '%';
                },

                getEngagementColor(rate) {
                    if (rate >= 5) return 'text-green-400';
                    if (rate >= 2) return 'text-yellow-400';
                    return 'text-red-400';
                },

                getPerformanceIcon(rate) {
                    if (rate >= 5) return '🔥';
                    if (rate >= 2) return '👍';
                    return '📈';
                },

                selectAnalyticsThread(thread) {
                    this.selectedAnalyticsThread = thread;
                },

                // Template functions
                getPopularTemplates() {
                    
                    const filtered = this.templates
                        .filter(template => {
                            // CRITICAL FIX: Always exclude Pro templates for non-premium users
                            // Use strict checking to handle undefined/null user states
                            if (template.isPro) {
                                // Only show Pro templates if user exists AND has premium
                                return this.user && this.user.premium === true;
                            }
                            return template.popularity >= 75;
                        })
                        .sort((a, b) => b.popularity - a.popularity)
                        .slice(0, 6);
                    
                    
                    // Fallback: if no popular templates, show first 6 non-pro templates
                    if (filtered.length === 0) {
                        const fallback = this.templates
                            .filter(template => !template.isPro)
                            .sort((a, b) => b.popularity - a.popularity)
                            .slice(0, 6);
                        return fallback;
                    }
                    
                    return filtered;
                },

                getFilteredTemplates() {
                    
                    let filtered = this.templates;

                    // CRITICAL FIX: Filter out Pro templates for non-premium users with strict checking
                    filtered = filtered.filter(template => {
                        if (template.isPro) {
                            // Only show Pro templates if user exists AND has premium
                            return this.user && this.user.premium === true;
                        }
                        return true;
                    });


                    // Apply category filter
                    if (this.selectedCategory !== 'all') {
                        filtered = filtered.filter(template => template.category === this.selectedCategory);
                    }

                    // Apply search filter
                    if (this.templateSearch.trim()) {
                        const searchTerm = this.templateSearch.toLowerCase();
                        filtered = filtered.filter(template => 
                            template.name.toLowerCase().includes(searchTerm) ||
                            template.description.toLowerCase().includes(searchTerm) ||
                            template.category.toLowerCase().includes(searchTerm)
                        );
                    }

                    const result = filtered.sort((a, b) => b.popularity - a.popularity);
                    return result;
                },

                selectTemplate(template) {
                    console.log('Selecting template:', template.name, 'isPro:', template.isPro, 'user premium:', this.user?.premium);
                    
                    // CRITICAL FIX: Block selection of Pro templates for non-premium users
                    if (template.isPro && (!this.user || !this.user.premium)) {
                        console.warn('Attempted to select Pro template without premium access - blocking');
                        // Close any existing modals first
                        this.showTemplateModal = false;
                        this.selectedTemplate = null;
                        // Show payment modal for upgrade
                        this.openPaymentModal();
                        return;
                    }
                    
                    this.selectedTemplate = template;
                    this.templateFormData = {};
                    // Initialize form data with empty values
                    template.variables.forEach(variable => {
                        this.templateFormData[variable] = '';
                    });
                    this.showTemplateModal = true;
                },

                closeTemplateModal() {
                    console.log('Closing template modal');
                    this.showTemplateModal = false;
                    this.selectedTemplate = null;
                    this.templateFormData = {};
                },

                formatVariableLabel(variable) {
                    return variable.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                },

                getVariablePlaceholder(variable) {
                    const placeholders = {
                        'product_name': 'e.g., ThreadrAI Pro',
                        'topic': 'e.g., social media marketing',
                        'company_name': 'e.g., Apple',
                        'time_period': 'e.g., 2 years',
                        'starting_point': 'e.g., struggling freelancer',
                        'challenge': 'e.g., low conversion rates',
                        'strategy': 'e.g., A/B tested email campaigns',
                        'results': 'e.g., 300% increase in sales',
                        'title': 'e.g., Atomic Habits',
                        'author': 'e.g., James Clear',
                        'opinion': 'e.g., Remote work is overrated',
                        'project': 'e.g., launching our SaaS product',
                        'website_url': 'e.g., https://threadr.ai',
                        'launch_date': 'e.g., March 15th',
                        'resource_link': 'e.g., https://example.com'
                    };
                    return placeholders[variable] || `Enter ${this.formatVariableLabel(variable).toLowerCase()}`;
                },

                generatePreviewTweets() {
                    if (!this.selectedTemplate) return [];
                    
                    return this.selectedTemplate.structure.map(tweet => {
                        let processedTweet = tweet;
                        
                        // Replace variables with form data or placeholders
                        this.selectedTemplate.variables.forEach(variable => {
                            const value = this.templateFormData[variable] || `{${variable}}`;
                            const regex = new RegExp(`\\{${variable}\\}`, 'g');
                            processedTweet = processedTweet.replace(regex, value);
                        });
                        
                        return processedTweet;
                    });
                },

                isTemplateFormValid() {
                    if (!this.selectedTemplate) return false;
                    
                    return this.selectedTemplate.variables.every(variable => 
                        this.templateFormData[variable] && this.templateFormData[variable].trim()
                    );
                },

                useTemplate() {
                    if (!this.isTemplateFormValid()) return;
                    
                    // Generate the final tweets
                    const generatedTweets = this.generatePreviewTweets().map((tweet, index) => ({
                        id: Date.now() + index,
                        text: tweet,
                        charCount: tweet.length
                    }));
                    
                    // Set the tweets in the main editor
                    this.tweets = generatedTweets;
                    
                    // Switch to the generate page
                    this.switchToPage('generate');
                    
                    // Close the modal
                    this.closeTemplateModal();
                    
                    // Show success message
                    this.showSuccessMessage('Template applied successfully! You can now edit and refine your thread.');
                },

                showSuccessMessage(message) {
                    // You could implement a toast notification here
                    // For now, we'll just use a simple approach
                    const originalError = this.error;
                    this.error = '';
                    setTimeout(() => {
                        // Could show a success state here
                    }, 100);
                },

                // Comparison methods
                addToComparison(thread) {
                    if (this.compareThreads.length < 2) {
                        this.compareThreads.push(thread);
                        console.log('Added thread to comparison');
                    }
                },

                removeFromComparison(threadId) {
                    this.compareThreads = this.compareThreads.filter(t => t.id !== threadId);
                    console.log('Removed thread from comparison');
                },

                showComparison() {
                    if (this.compareThreads.length === 2) {
                        this.showComparisonModal = true;
                        console.log('Showing comparison modal');
                    }
                },

                closeComparison() {
                    this.showComparisonModal = false;
                }
            }
        }

    </script>
</body>
</html>